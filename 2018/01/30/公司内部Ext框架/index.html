<!DOCTYPE html>
<html lang="z">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    
    <title>公司内部Ext框架使用注意事项或者叫开发指南 | Ronaldo</title>
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="以下内容不全是我一个人理解分析的,感谢前辈们: 陈德林、徐冬冬、大许磊、沈梁以及黄建雄的帮忙！

公司内部Ext框架是老板在Ext基础上封装好的,使用起来极为方便,基本上就是复制粘贴改数据,但前提是你知道在哪里改。
导航
显示页面
框架学习
OnBeforeFormLoad()
tools.SetToolbar()
tools.GetMenuAuth()
OnMenuClick()
tools.">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="公司内部Ext框架使用注意事项或者叫开发指南 | Ronaldo">
    <meta name="twitter:description" content="以下内容不全是我一个人理解分析的,感谢前辈们: 陈德林、徐冬冬、大许磊、沈梁以及黄建雄的帮忙！

公司内部Ext框架是老板在Ext基础上封装好的,使用起来极为方便,基本上就是复制粘贴改数据,但前提是你知道在哪里改。
导航
显示页面
框架学习
OnBeforeFormLoad()
tools.SetToolbar()
tools.GetMenuAuth()
OnMenuClick()
tools.">

    <meta property="og:type" content="article">
    <meta property="og:title" content="公司内部Ext框架使用注意事项或者叫开发指南 | Ronaldo">
    <meta property="og:description" content="以下内容不全是我一个人理解分析的,感谢前辈们: 陈德林、徐冬冬、大许磊、沈梁以及黄建雄的帮忙！

公司内部Ext框架是老板在Ext基础上封装好的,使用起来极为方便,基本上就是复制粘贴改数据,但前提是你知道在哪里改。
导航
显示页面
框架学习
OnBeforeFormLoad()
tools.SetToolbar()
tools.GetMenuAuth()
OnMenuClick()
tools.">

    
    <meta name="author" content="lizhongzhen">
    
    <link rel="stylesheet" href="/css/vno.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

    
    <link rel="icon" href="/images/logo.jpg">
    

    <meta name="generator" content="hexo"/>
    
    <link rel="alternate" type="application/rss+xml" title="Ronaldo" href="/atom.xml">
    

    <link rel="canonical" href="http://yoursite.com/2018/01/30/公司内部Ext框架/"/>

                 
</head>

<body class="home-template no-js">
    <script src="//cdn.bootcss.com/jquery/2.1.4/jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>

    
<header class="panel-cover panel-cover--collapsed" style="background-image: url(/images/Daniel.jpg)">
  <div class="panel-main">
    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/" title="前往 Ronaldo 的主页"><img src="/images/logo.jpg" width="80" alt="Ronaldo logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/" title="link to homepage for Ronaldo">Ronaldo</a></h1>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description"></p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />

        <div class="navigation-wrapper">
          <div>
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="Visit the blog" class="blog-button">Blog</a></li>
            
              <li class="navigation__item"><a href="https://github.com/lizhongzhen11/lizhongzhen11.github.io">目录</a></li>
            
            </ul>
          </nav>
          </div>
          <div>
          <nav class="cover-navigation navigation--social">
  <ul class="navigation">

  <!-- Weibo-->
  
  <li class="navigation__item">
    <a href="http://weibo.com/3298783260/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" title="Weibo" target="_blank">
      <i class='social fa fa-weibo'></i>
      <span class="label">Weibo</span>
    </a>
  </li> 


  <!-- Github -->
  
  <li class="navigation__item">
    <a href="https://github.com/lizhongzhen11" title="GitHub" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>


<!-- Stack Overflow -->
        

  <!-- Google Plus -->
  

<!-- Facebook -->

  
<!-- Twitter -->

  

  <li class="navigation__item">
    <a href="/atom.xml" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>



  </ul>
</nav>

          </div>
        </div>

      </div>

    </div>

    <div class="panel-cover--overlay cover-purple"></div>
  </div> 
</header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single">

  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-01-30T07:19:54.284Z" class="post-list__meta--date date">2018-01-30</time> &#8226; <span class="post-meta__tags tags">于  </span>
      <span class="page-pv">
       Read <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>
      </span> 
   
    </div>
    <h1 class="post-title">公司内部Ext框架使用注意事项或者叫开发指南</h1>
  </header>

  <section class="post">
    <blockquote>
<p><strong>以下内容不全是我一个人理解分析的,感谢前辈们: 陈德林、徐冬冬、大许磊、沈梁以及黄建雄的帮忙！</strong></p>
</blockquote>
<p><strong>公司内部Ext框架是老板在Ext基础上封装好的,使用起来极为方便,基本上就是复制粘贴改数据,但前提是你知道在哪里改。</strong></p>
<h3 id="导航"><a href="#导航" class="headerlink" title="导航"></a><a id="1">导航</a></h3><ul>
<li><a href="#2">显示页面</a></li>
<li><a href="#3">框架学习</a><ul>
<li><a href="#31">OnBeforeFormLoad()</a><ul>
<li><a href="#311">tools.SetToolbar()</a></li>
<li><a href="#312">tools.GetMenuAuth()</a></li>
<li><a href="#313">OnMenuClick()</a></li>
<li><a href="#314">tools.DeleteToolbarItemByAuth()</a></li>
</ul>
</li>
<li><a href="#32">OnBeforeCreateEdit()</a><ul>
<li><a href="#321">OnPrdIdSelect(),OnPrdIdBeforeLoad()以及OnPrdIdSearch()</a></li>
<li><a href="#322">OnInitData()</a></li>
<li><a href="#323">OnFormLoad()–加载主页面方法,重点</a></li>
<li><a href="#324">OnLoadData()</a></li>
<li><a href="#325">附件相关学习</a></li>
<li><a href="#326">附上上传附件通用代码</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4">踩坑集锦</a><ul>
<li><a href="#41">附件下载、预览踩坑</a></li>
<li><a href="#42">Could not find action or result;No result defined for action</a></li>
<li><a href="#43">select选择框</a></li>
<li><a href="#44">保存时主键冲突提示语改变</a></li>
<li><a href="#45">新增时发现数据默认-2以及me.disNews</a></li>
<li><a href="#46">双击列表跳转页面查看详情时发现有些字段没有值</a></li>
<li><a href="#47">从父类复制过来的按钮没有显示</a></li>
<li><a href="#48">权限问题</a></li>
<li><a href="#49">数据中存在空格、换行等页面展示/n字符问题</a></li>
<li><a href="#50">进入详情页控制台报<code>cannot read property &#39;getLeft&#39; of undefined</code>问题</a></li>
<li><a href="#51">详情页有附件面板,新增时,附件面板默认出现某条数据的问题</a></li>
<li><a href="#52">下拉框验证问题</a></li>
<li><a href="#53">部分 word 2007/2010不能预览问题</a></li>
</ul>
</li>
</ul>
<h3 id="一、喷！！！"><a href="#一、喷！！！" class="headerlink" title="一、喷！！！"></a>一、喷！！！</h3><p>why 喷？？？</p>
<blockquote>
<p>喷死你！！！</p>
</blockquote>
<p>why ？？？</p>
<blockquote>
<p>喷死你！！！</p>
</blockquote>
<p>…<br>作为公司主力开发后台管理系统的框架,基本上人人都会写上几次,有的一直写,写的多了习惯了,而有的客串写,就真的想日狗(要日萨摩耶…)。<br>为什么想日狗？？？<br><strong>公司居然没有一份入门指南或者开发注意事项！！！</strong><br>这简直就是奇葩！！！<br>市面上任何框架几乎都会写一些使用指南,不管写得好不好。<br>而公司目前绝大多数项目后台管理系统都是用的该框架,有时候任务急人手不够时需要帮忙写,写过的还好,没写过的就很烦躁了。因为要踩很多坑。<br>有的坑即使前辈们来帮忙填的时候也很难,因为很有可能不是代码问题,而是缺少配置文件。。。<br>真的,遇到这种问题心都痛。<br>想想自己辛辛苦苦找了一两天还是找不到bug,后来发现少两个文件(例如,附件预览需要本地有<strong>SWFTools</strong>和<strong>LibreOffice 5</strong>两个文件,不然报错始终看不了。心疼自己,哭哭哭哭哭哭哭哭…)<br>不要问为什么同事没告诉你,同事不忙吗,偶尔有时间帮你看,他们也很少想到是因为少文件出的错。<br>balabalabalabala…<br>算了,不说了,说多了都是泪,我自己写采坑集锦！</p>
<h3 id="二、第一步-看到自己写的页面"><a href="#二、第一步-看到自己写的页面" class="headerlink" title="二、第一步,看到自己写的页面"></a><a id="2">二、第一步,看到自己写的页面</a></h3><p><strong>由于老板封装好了,所以想看到自己写的页面需要在数据库进行配置。</strong></p>
<p>举例：<br>1.复制已有的某个页面,其实就是 js 文件。</p>
<p><img src="../../../../images/ext_title.png" alt=""></p>
<blockquote>
<p>如上图,<code>Ext.define(&#39;gmo.trmprojectDeclare&#39;)</code>这里的<code>trmprojectDeclare</code>代表的是你这个js的名字,其中,js文件名应该与它一致。(如果是复制过来的,请改个名字然后去数据库配置。)<br><code>editinfo</code>属性一般跟页面标题一样,可以改成自己喜欢的名字。</p>
</blockquote>
<p>上面的<code>gmo</code>应该是项目名,暂时我还不知道在哪里配置的。</p>
<blockquote>
<p><code>extend: &#39;gpersist.base.busform&#39;</code>,看到<code>extend</code>顾名思义就知道是继承的意思。其实就是该页面的父类是<code>gpersist.base.busform</code>,所有父类里面的方法他都能直接调用或重写。</p>
</blockquote>
<p><img src="../../../../images/ext_father.png" alt=""><br><strong>从图上可以看到,我的父类都是在 <code>jslib</code> 文件夹下,但是它继承的开头是 <code>gpersist</code>, 我不知道他在哪里配置改名的</strong></p>
<blockquote>
<p>OK,接下来需要去数据库配置让我们复制并改名的js在页面上显示</p>
</blockquote>
<p>2.数据库配置</p>
<blockquote>
<p>首先去<code>T_Sys_Menu_Group</code>这张表里看各个大目录,然后去<code>T_Sys_Menu</code>这张表里根据被我们复制的原始页面标题查询(对应<code>MName</code>字段)。可以得到<code>MID</code>以及<code>MFunction</code>等字段。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;假设查询得到的<code>MID</code>是101,<strong>101代表着是<code>T_Sys_Menu_Group</code>这张表里<code>MgID</code>为1的目录下的第一个子菜单</strong>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接下来直接在<code>T_Sys_Menu</code>手动插入数据,假设<code>MID=102</code>没有,那么插入一条数据：<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MID: 102, MPID: 102(一般和MID一样), MgID: 1(父级菜单id), MDisp: 102(一般和MID一样), MCode: 102,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MFunction(其实就是路径名): 照着101的改。其他字段都差不多,复制粘贴就好。</p>
<blockquote>
<p>接下来要给我们新增的页面赋权限。用到<code>T_Sys_Menu_Detail</code>,<code>T_Sys_Role_Detail</code>,<code>T_Sys_Role_Menu</code>这三张表。(正常情况下表名差不多)</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我一直用的最傻的方法,就是手动给三张表加数据,直到开始写这篇文章才知道可以直接在管理系统上赋权限的。。。<br><strong>第一种方法,表里加数据</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先看<code>T_Sys_Menu_Detail</code>这张表,只有两个字段:<code>AuthID</code>和<code>MID</code>。<code>MID</code>就是我们之前设置好的102,那么<code>AuthID</code>是什么呢？</p>
<blockquote>
<p>打开<code>T_Sys_Menu_Auth</code>表,可以看到<code>AuthID</code>对应的名称,其实就是按钮权限。当在<code>T_Sys_Menu_Detail</code>表里设置: MID: 102, AuthID: 1.就代表了该页面能被查看。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后是<code>T_Sys_Role_Detail</code>表,这个表里面有个<code>RoleID</code>字段,其实是用来给不同角色分配不同权限的。详情可以查看<code>T_Sys_Role</code>表,这个表里对各个角色进行了分类。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最后是<code>T_Sys_Role_Menu</code>表,这个表的<code>MAuth</code>字段不大理解什么意思,据组长说貌似是个二进制数据,对应有没有选中。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;好了,数据全部插进去了,这时候页面上还是看不到的,需要去系统里面点击功能操作权限生成,如下图：<br><img src="../../../../images/ext_quanxian.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不出意外的话,浏览器上应该能看到刚刚新建的页面了。</p>
<p><strong>第二种方法,直接在系统里点击角色分配</strong></p>
<blockquote>
<p>仍然需要先去<code>T_Sys_Menu</code>这张表里插数据。然后不需要手动去另外三张表插数据,直接打开后台管理系统,找到系统管理下的角色管理进行权限设置即可。</p>
</blockquote>
<p><img src="../../../../images/ext_quanxian2.png" alt=""></p>
<h3 id="三、第二步-修改页面内容并大概理解页面具体生成机制"><a href="#三、第二步-修改页面内容并大概理解页面具体生成机制" class="headerlink" title="三、第二步,修改页面内容并大概理解页面具体生成机制"></a><a id="3">三、第二步,修改页面内容并大概理解页面具体生成机制</a></h3><p><strong><a href="#1">返回目录</a></strong></p>
<blockquote>
<p>这边打算对每个属性和方法进行分析理解</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">constructor:function(config)&#123;</div><div class="line">      var me = this;                // 保存this,apply方法能够改变this指向</div><div class="line">      Ext.apply(config,&#123;</div><div class="line">          editInfo:&apos;项目管理&apos;,       // 弹出框的标题</div><div class="line">          winWidth:750,             // 这个设置的是弹出窗的宽度</div><div class="line">          winHeight:450,            // 这个设置的是弹出窗的高度</div><div class="line">          hasColumnUrl:true,        // 说实话,我改为false页面依然能用没报错,不知道有什么用。busform.js和baseform.js都没有这个属性</div><div class="line">          columnUrl:&apos;SysSqlColumn.do?sqlid=p_get_column&apos;,   // 一般页面都是列表形式展示,这里接口获得列表页的列名,</div><div class="line">                                                            // 在T_Set_Sql_Column表里面配置,其中p_get_column是存储过程</div><div class="line">          storeUrl:&apos;Search&apos;,        // Search接口,用来获取数据放到页面上的</div><div class="line">          saveUrl:&apos;&apos;,               // 顾名思义,这里是保存接口</div><div class="line">          expUrl:&apos;&apos;,                // 导出接口,看各个页面上几乎都是Search接口</div><div class="line">          deleteUrl:&apos;&apos;,             // 删除接口</div><div class="line">          checkUrl: &apos;&apos;,             // 审核接口</div><div class="line">          &lt;!-- 分割,美观 --&gt;</div><div class="line">          idPrevNext:&apos;&apos;,            // 暂时不清楚。父类中在 OnLoadData 方法里判断 record.idPrevNext 是否有值,有的话通过 OnSetData </div><div class="line">                                    // 返回 true; 也在 OnFormEdit 方法中判断 idPrevNext 是否为空,不为空设置 </div><div class="line">                                    // me.dataDeal = gpersist.DATA_DEAL_EDIT 以及判断 </div><div class="line">                                    // me.OnSetData(tools.GetValue(mep + me.idPrevNext)) 是否为true,</div><div class="line">                                    // (这里跟踪到 tools.GetValue() 发现用了 Ext.getCmp(id).getValue(), 这是 Ext 自己的方法,</div><div class="line">                                    // 可以得到一个 String 值。)</div><div class="line">                                    // 为true的话调用 OnAuthEditForm 方法, me.OnAuthEditForm(2, true);</div><div class="line">                                    // OnAuthEditForm方法管理 页面空间授权处理,由于传入的是 2 即 DATA_DEAL_EDIT ,所以才去授予的权限</div><div class="line">          &lt;!-- 分割,美观 --&gt;</div><div class="line">          hasDetail: true,          // 父类默认是 false ;然后在 OnFormLoad() 加载主页面方法里判断是否为 true, </div><div class="line">                                    // true 的话调用 pleditview.add(me.plDetail) 同时继续判断 me.plDetail &amp;&amp; !me.hasEdit 是否为</div><div class="line">                                    // true, true的话应该是让 me.plDetail 面板居中的意思</div><div class="line">                                    // pleditview.add(me.plDetail) 方法其实是在 pleditview 面板里加一个 plDetail 面板;</div><div class="line">                                    // 然后在 OnCreateEditWin() 方法里再次判断 hasDetail 是否为 true, true 的话创建了几个面板,</div><div class="line">                                    // 调用了 OnGetDetailFunction(), OnBeforeCreateDetail(), OnAfterCreateDetailToolBar(),</div><div class="line">                                    // OnAfterCreateDetail() 四个方法,应该是进行面板初始化创建的。</div><div class="line">                                    // 之后在 OnGetSaveParams() 方法里也判断了 hasDetail 是否为 true, true的话把</div><div class="line">                                    // me.plDetailGrid.store.getAt(i).data的数据循环放进新数组 details 里面,</div><div class="line">                                    // 把 &#123; details: Ext.encode(details) &#125; 赋值给 me.saveParams。</div><div class="line">                                    // 其中 Ext.encode()函数将Json对象转换成Json格式字符串。([1,2] ==&gt; &quot;[1,2]&quot;)</div><div class="line">                                    // &#123; details: Ext.encode(details) &#125; 是一个对象, 第一个 details 是该对象的属性名,</div><div class="line">                                    // 不是之前的那个数组,注意下！</div><div class="line">          &lt;!-- 分割,美观 --&gt;                           </div><div class="line">          hasDetailEdit: true,      // 默认 false ;先在 OnCreateEditWin() 方法里判断是否为 true, true的话调用</div><div class="line">                                    // me.plDetailGrid.insertDocked(0, tbdetailedit)</div><div class="line">                                    // tbdetailedit 是一个头部工具栏,insertDocked()方法没找到,可能是Ext自带的,这个方法的意思应该</div><div class="line">                                    // 是在 plDetailGrid 面板中插入一个头部工具栏。</div><div class="line">          &lt;!-- 分割,美观 --&gt;</div><div class="line">          hasPage: true,            // 默认是true,先在 OnBeforeFormLoad() 方法中判断(该方法用于在加载页面前初始化工具栏的)。</div><div class="line">                                    // 如果判断为true,使用Ext.Array.insert()方法,这是Ext的扩展工具方法,用于在数组中插入</div><div class="line">                                    // 一个新数组。</div><div class="line">                                    // 经过试验,发现把 hasPage 设为 false,页面底部的分页没有了。所以这个属性可以控制分页。</div><div class="line">                                    // 研究父类发现是在 OnFormLoad() 方法里控制的。</div><div class="line">                                    // 在 OnSearch() 方法里也有用到。</div><div class="line">          &lt;!-- 分割,美观 --&gt;                          </div><div class="line">          hasExit: true,            // 父类没找到该方法。改为false页面无报错能正常展示。</div><div class="line">          height:320,               // 父类没有,不知道哪来的。。。估计是自己定义的吧</div><div class="line">          hasDetailGrid:true,       // 父类没有</div><div class="line">          hasDetailEditTool: true,  // 父类没有</div><div class="line">          hasPrevNext: false,       // 默认是 true, 先在 OnCreateEditWin() 方法中判断,true的话加 上一条和下一条 共两个按钮</div><div class="line">          hasGridSelect: true,      // 默认是 false, 主要在 OnFormLoad() 方法中有这么一个判断:</div><div class="line">                                    // selModel: me.hasGridSelect ? new Ext.selection.CheckboxModel(&#123; injectCheckbox: 1 &#125;) </div><div class="line">                                    // : &#123;&#125;, 查了下,这是控制页面列表默认选中第几行的。true默认显示第一行,false默认不选中。</div><div class="line">          &lt;!-- 分割,美观 --&gt;                          </div><div class="line">          hasDetailCheck: false,    // 默认是 true, 在 OnCreateEditWin() 里作为参数传入 tools.GetGridColumnsByUrl() 方法,</div><div class="line">                                    // 看了下 tools.GetGridColumnsByUrl() 方法,发现如果 hasDetailCheck 为 true 的话,</div><div class="line">                                    // 会创建 checkbox 列。</div><div class="line">          &lt;!-- 分割,美观 --&gt;                          </div><div class="line">          hasDetailGridSelect:true, // 默认是 false, 在父类上看到,该属性与 hasDetailCheck 一起使用的。</div><div class="line">      &#125;);</div><div class="line">      me.callParent(arguments);     // 这一步调用父类的方法,同时覆盖同名的方法。</div><div class="line">   &#125;,</div></pre></td></tr></table></figure>
<blockquote>
<p>接下来开始构建页面,一般紧接着 constructor() 的是 <a id="31">OnBeforeFormLoad()</a></p>
</blockquote>
<p><a href="#1">返回目录</a></p>
<p>例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">OnBeforeFormLoad:function()&#123;</div><div class="line">     var me = this;</div><div class="line">     var mep = me.tranPrefix;</div><div class="line">     me.plLeft= null,</div><div class="line">     me.plRight= null,</div><div class="line">     me.attach4 = [],</div><div class="line">     me.OnInitGridToolBar();</div><div class="line">     var item1 = [</div><div class="line">         &apos; &apos;,&#123;xtype:&apos;textfield&apos;,fieldLabel:&apos;项目名称&apos;,labelWidth:70,width:220,maxLength:20,</div><div class="line">         name:&apos;searchprojectname&apos;,id:mep+&apos;searchprojectname&apos;,allowBlank:true&#125;,</div><div class="line">         &apos; &apos;, tools.GetToolBarCombo(&apos;searchbasetype&apos;, mep + &apos;searchprojecttype&apos;, 180, &apos;项目类型&apos;, </div><div class="line">         60, tools.ComboStore(&apos;ProjectType&apos;,gpersist.SELECT_ALL_VALUE)),</div><div class="line">        ];</div><div class="line">     var item2 = [</div><div class="line">        // 搜索按钮</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnSearch&apos;, text: gpersist.STR_BTN_SEARCH, iconCls: &apos;icon-find&apos;, handler: me.OnSearch, scope: me &#125;,</div><div class="line">        // 新增按钮</div><div class="line">        &apos;-&apos;, &apos; &apos;, &#123; id: mep + &apos;btnAdd&apos;, text: gpersist.STR_BTN_NEW, iconCls: &apos;icon-add&apos;, handler: me.OnNew,scope: me &#125;,</div><div class="line">        // 复制按钮</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnCopy&apos;, text: gpersist.STR_BTN_COPY, iconCls: &apos;icon-add&apos;, handler: me.OnCopy,scope: me&#125;,</div><div class="line">        // 编辑按钮</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnEdit&apos;, text: gpersist.STR_BTN_EDIT, iconCls: &apos;icon-edit&apos;, handler: me.OnEdit,scope: me&#125;, </div><div class="line">        // 删除按钮</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnDelete&apos;, text: gpersist.STR_BTN_DELETE, iconCls: &apos;icon-delete&apos;, handler: me.OnDelete,scope: me&#125;,</div><div class="line">        // 处理按钮(这里发现页面上处理按钮没有展示出来,很有可能是 id 冲突了,试试把 id 改了)</div><div class="line">        &apos;-&apos;, &apos; &apos;, &#123; id: mep + &apos;btnDeal2&apos;, text: gpersist.STR_BTN_DEAL, iconCls: &apos;icon-deal&apos;, handler: me.OnDeal, scope: me &#125;,</div><div class="line">        // 审核按钮(这里发现页面上处理按钮没有展示出来,很有可能是 id 冲突了,试试把 id 改了)</div><div class="line">        &apos;-&apos;, &apos; &apos;, &#123; id: mep + &apos;btnCheck1&apos;, text: &apos;审核&apos;, iconCls: &apos;icon-audit&apos;, handler: me.OnCheck,scope: me&#125;,</div><div class="line">        // 取消审核按钮(不出现的话可能与审核按钮那边一样)</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnUnCheck1&apos;, text: &apos;取消审核&apos;, iconCls: &apos;icon-unaudit&apos;, handler: me.OnUnCheck,scope: me&#125;,</div><div class="line">        // 导出按钮</div><div class="line">        &apos;-&apos;, &apos; &apos;, &#123; id: mep + &apos;btnExport&apos;, text: gpersist.STR_BTN_EXPORT, iconCls: &apos;icon-export&apos;, handler: me.OnExport, scope: me &#125;,</div><div class="line">        // 打印按钮</div><div class="line">        &apos; &apos;, &#123; id: mep + &apos;btnPrint&apos;, text: gpersist.STR_BTN_PRINT, iconCls: &apos;icon-print&apos;, handler: me.OnPrint, scope: me &#125;,</div><div class="line">        // 刷新按钮,页面上是个小球的图标</div><div class="line">        &apos;-&apos;, &apos; &apos;, &#123; tooltip: gpersist.STR_BTN_REFRESH_NOW, iconCls: &apos;icon-pagerefresh&apos;, handler: me.OnResetForm, scope: me &#125;</div><div class="line">      ];</div><div class="line">     tools.SetToolbar(item1,mep);</div><div class="line">     tools.SetToolbar(item2,mep);</div><div class="line">     var toolbar1 = Ext.create(&apos;Ext.toolbar.Toolbar&apos;,&#123;items:item1,border:false&#125;);</div><div class="line">     var toolbar2 = Ext.create(&apos;Ext.toolbar.Toolbar&apos;,&#123;items:item2,border:false&#125;);</div><div class="line">     me.tbGrid.add(toolbar1);</div><div class="line">     me.tbGrid.add(toolbar2);</div><div class="line">   &#125;,</div></pre></td></tr></table></figure></p>
<p><img src="../../../../images/ext_toolbar.png" alt=""></p>
<blockquote>
<p>如上图所示(上图并不对应我们代码里的内容,只是举个列子),项目编号和项目名称这一行对应<code>item1</code>,第二行的查询等按钮对应<code>item2</code>。</p>
</blockquote>
<p><strong><a href="#1">返回目录</a></strong></p>
<p>接下来分析一波<code>tools.SetToolbar(item1,mep)</code>以及<code>me.tbGrid.add(toolbar1)</code><br><a id="311">tools.SetToolbar()</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">tools.SetToolbar = function (items, mcode) &#123;</div><div class="line">	//var sauth = tools.GetMenuAuth(mcode);</div><div class="line">	var sauth = tools.GetAuth(mcode);</div><div class="line">	// 增加 </div><div class="line">  tools.DeleteToolbarItemByAuth(sauth, items, mcode + &apos;btnAdd&apos;, 2, tools.ValidSeparator(sauth, 14));</div><div class="line">  tools.DeleteToolbarItemByAuth(sauth, items, mcode + &apos;btnCopy&apos;, 2);</div><div class="line">  ...</div><div class="line">&#125;</div><div class="line">tools.GetAuth = function(mcode) &#123;</div><div class="line">  var rtn = 0;</div><div class="line">  if (gpersist &amp;&amp; gpersist.UserInfo &amp;&amp; gpersist.UserInfo.auths) &#123;</div><div class="line">    Ext.each(gpersist.UserInfo.auths, function (auth, index) &#123;</div><div class="line">      if (auth.mcode == mcode) &#123;</div><div class="line">        rtn = auth.mauth;</div><div class="line">        return;</div><div class="line">      &#125;</div><div class="line">    &#125;);   </div><div class="line">  &#125;</div><div class="line">  return rtn;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>如上所示,<code>tools.SetToolbar(item1,mep)</code>传入了<code>item1</code>和<code>mep</code>,<code>item1</code>我们知道了,但是<code>mep</code>呢？<br><code>var mep = me.tranPrefix</code>即把<code>me.tranPrefix</code>赋值给<code>mep</code>,那么<code>tranPrefix</code>是什么？</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;继续看父类,不是在 busform.js 里定义的,那就去 baseform.js 里找。果然,抬头就看见<code>tranPrefix: &#39;0000&#39;</code>,也就是说这个属性初始值是个String,但是有什么用呢？不急,继续往下看呗。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在 <code>constructor()</code> 就开始用了 <code>me.OnInitConfig(); me.sauth = tools.GetMenuAuth(me.tranPrefix)</code>,可是初始化的值不是’0000’吗,传过去干嘛的呢？</p>
<p><strong><a href="#1">返回目录</a></strong></p>
<p>看看<a id="312">tools.GetMenuAuth()</a>方法呗<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">tools.GetMenuAuth = function(mcode) &#123;</div><div class="line">	var sauth = &apos;&apos;;</div><div class="line">	if (gpersist &amp;&amp; gpersist.UserInfo &amp;&amp; gpersist.UserInfo.auths) &#123;</div><div class="line">		Ext.each(gpersist.UserInfo.auths, function (auth, index) &#123;</div><div class="line">	  	if (auth.mcode == mcode) &#123;</div><div class="line">	  		sauth = auth.mauth.toString(2);</div><div class="line">	  		return false;</div><div class="line">	  	&#125;</div><div class="line">	  &#125;);		</div><div class="line">	&#125;</div><div class="line">	return sauth;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;假设把’0000’传了进去,接下去走,需要判断<code>gpersist &amp;&amp; gpersist.UserInfo &amp;&amp; gpersist.UserInfo.auths</code>为true,这时候又需要去看看<code>gpersist.UserInfo</code> 和 <code>gpersist.UserInfo.auths</code> 是什么了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">gpersist.OnInit = function() &#123;</div><div class="line">  //if (!eval(gpersist.CLASS_BASE))</div><div class="line">  //  gpersist.LoadJs([gpersist.URL_BASE_CLASS], gpersist.NullCallBack, &apos;&apos;);</div><div class="line">  if (!Ext.isDefined(gpersist.AllParams))</div><div class="line">    gpersist.AllParams = Ext.create(&apos;Ext.util.MixedCollection&apos;);</div><div class="line">  gpersist.GetSessionUser();</div><div class="line">&#125;;</div><div class="line">gpersist.InitUserInfo = function() &#123;</div><div class="line">  gpersist.UserInfo = null;</div><div class="line">&#125;;</div><div class="line">gpersist.GetUserInfo = function() &#123;</div><div class="line">  if (gpersist.UserInfo)</div><div class="line">    return gpersist.UserInfo;</div><div class="line">   else</div><div class="line">    return null;</div><div class="line">&#125;;</div><div class="line">gpersist.GetSessionUser = function () &#123;</div><div class="line">  if (!Ext.isDefined(gpersist.UserInfo)) &#123;</div><div class="line">    var record = tools.JsonGet(gpersist.ACTION_GET_ONLINEINFO);</div><div class="line">    if (record &amp;&amp; record.data)</div><div class="line">      gpersist.UserInfo = record.data;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">tools.JsonGet = function (url, params) &#123;</div><div class="line">	var data = [];</div><div class="line">	params = params || &#123;&#125;;</div><div class="line">	Ext.Ajax.request(&#123;</div><div class="line">		url: url,</div><div class="line">		params: params,</div><div class="line">		async: false,</div><div class="line">		success: function (response, opts) &#123;</div><div class="line">			//alert(response.responseText);</div><div class="line">			try &#123;</div><div class="line">			data = Ext.decode(response.responseText.replace(/\r\n/g,&apos;&lt;br/&gt;&apos;).replace(/\&quot;(new Date\((-*)\d+\))\&quot;/g,&apos;$1&apos;));</div><div class="line">			&#125;</div><div class="line">			catch(ex) &#123;</div><div class="line">				alert(&quot;JsonGet:&quot; + ex.toString());</div><div class="line">			&#125;	</div><div class="line">		&#125;,</div><div class="line">		failure: function (response) &#123; &#125;</div><div class="line">	&#125;);</div><div class="line">	return data;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从上面代码分析可以得知,在<code>OnInit()</code>方法中调用了<code>GetSessionUser()</code>方法,在<code>GetSessionUser()</code>里判断<code>UserInfo</code>属性有没有定义,如果没有定义,通过<code>tools.JsonGet()</code>方法调后台接口(gpersist.ACTION_GET_ONLINEINFO就是我们定义的后台接口地址),得到返回数据。然后对<code>UserInfo</code>属性进行赋值。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;接下来继续回过去看<code>GetMenuAuth()</code>方法就很好理解了,它遍历了<code>gpersist.UserInfo.auths</code>,通过满足<code>auth.mcode == mcode</code>条件来对<code>sauth</code>赋值并返回。</p>
</blockquote>
<p><strong>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是,经过我在页面上打印输出发现<code>tranPrefix</code>并不是’0000’,这就说明在<code>GetMenuAuth()</code>之前已经通过掉后台接口改变了<code>tranPrefix</code>值。可是,无论我怎么翻看baseform.js和busform.js都找不到任何一个在这之前调后台接口并给<code>tranPrefix</code>赋值的方法,百思不得其解,很郁闷。</strong><br><strong>&nbsp;&nbsp;&nbsp;&nbsp;最后,去请教了陈德林老师,经过陈老师一讲,瞬间明白了。我只盯着一个页面,却忘记了项目是从登录开始的,项目真正的基础是basemain.js！！！在basemain.js里面调方法接收后台数据,所以像<code>tranPrefix</code>这样的属性已经通过basemain.js里面的方法进行了赋值。</strong><br>为了接下来能跑的通,理解的通,我们需要去查看basemain.js了。</p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;代码太多,就不怎么贴出来了。basemain.js构造函数里面一上来就通过<code>gpersist.GetSessionUser()</code>进行赋值;然后又调用了<code>OnLogin()</code>方法,进而调用了<code>gpersist.LoadJs()</code>方法登录。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后通过<code>topToolbar.add(me.OnCretaeMenu())</code>增加了<code>OnCretaeMenu()</code>方法。</p>
</blockquote>
<p><strong>那么,什么时候对<code>tranPrefix</code>进行赋值的呢？basemain.js里并没有可用的<code>tranPrefix</code>,唯一的还被注释掉了。这里我们好像又断了头绪,怎么办？</strong></p>
<blockquote>
<p>这里貌似并没有什么好的查询方法,要么全局搜,要么一个方法一个方法的看。好在运气不错,在gpersist.js里面找到了对<code>tranPrefix</code>赋值的操作。</p>
</blockquote>
<p><a id="313">OnMenuClick()</a><br><strong><a href="#1">返回目录</a></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">// basemain.js</div><div class="line">OnMenuClick: function(data) &#123;</div><div class="line">    if (data.leaf) &#123;</div><div class="line">      if (!data.istab) &#123;</div><div class="line">        gpersist.OnMenuClick(data);</div><div class="line">        return;</div><div class="line">      &#125;</div><div class="line">      ...</div><div class="line">    listeners: &#123;</div><div class="line">      &apos;close&apos;: function() &#123;</div><div class="line">        if(Ext.isIE) &#123; </div><div class="line">          CollectGarbage(); </div><div class="line">        &#125;</div><div class="line">      &#125;,</div><div class="line">      &apos;afterrender&apos;: function() &#123; </div><div class="line">        gpersist.OnMenuClick(data); </div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">// gpersist.js</div><div class="line">gpersist.OnMenuClick = function(menu) &#123;</div><div class="line">  if (menu &amp;&amp; menu.url) &#123;</div><div class="line">    var menubean = menu.url.lastIndexOf(&quot;/&quot;) &gt;= 0 ? menu.url.substring(menu.url.lastIndexOf(&quot;/&quot;) + 1) : menu.url;</div><div class="line">    var prefix = gpersist.STR_SYS_NAME + &apos;.&apos;;</div><div class="line">    if (menu.mid &gt;= 8000)</div><div class="line">      prefix = &apos;gpersist.&apos;;</div><div class="line">    if (eval(prefix + menubean)) &#123;</div><div class="line">      Ext.create(prefix + menubean, &#123;mid:menu.mid,tranPrefix:menu.mcode&#125;);</div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">      gpersist.LoadJs([menu.url + &apos;.js&apos;], gpersist.DefaultTranCallBack, menu);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">gpersist.DefaultTranCallBack = function() &#123;</div><div class="line">  var menu = gpersist.JsLoadCallBackParam;</div><div class="line">  if (menu &amp;&amp; menu.url) &#123;</div><div class="line">    var menubean = menu.url.lastIndexOf(&quot;/&quot;) &gt;= 0 ? menu.url.substring(menu.url.lastIndexOf(&quot;/&quot;) + 1) : menu.url;</div><div class="line">    var prefix = gpersist.STR_SYS_NAME + &apos;.&apos;;</div><div class="line">    if (menu.mid &gt;= 8000)</div><div class="line">      prefix = &apos;gpersist.&apos;;</div><div class="line">    if (eval(prefix + menubean)) &#123;</div><div class="line">      Ext.create(prefix + menubean, &#123;mid:menu.mid,tranPrefix:menu.mcode&#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;从上可以看出,因为<code>OnMenuClick()</code>是定义在basemain.js里面的方法,而在basemain.js里面的<code>OnMenuClick()</code>里又调用了<code>gpersist.OnMenuClick(data)</code>,观察<code>gpersist.OnMenuClick()</code>方法:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>如果<code>eval(prefix + menubean)</code>存在的话对<code>tranPrefix</code>赋值为<code>menu.mcode</code>,</strong><br>如果不存在调用<code>gpersist.LoadJs([menu.url + &#39;.js&#39;], gpersist.DefaultTranCallBack, menu)</code>方法。依然会对<code>tranPrefix</code>赋值为<code>menu.mcode</code></p>
</blockquote>
<p>结合名称可以知道是在点击目录的时候调用该方法并进行了赋值。<strong>那怎么给点击事件绑定<code>OnMenuClick()</code>方法呢？</strong></p>
<blockquote>
<p>结合页面点击分析,我们在点击页面左侧目录栏的时候会触发该事件,那么找到左侧目录栏应该就能找到绑定的点击事件了。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这时候又需要我们去找了,确实蛮难找的。好在有全局搜索,我们发现除了basemain.js和gpersist.js里面有该方法,还在<strong>main.js</strong>和<strong>hmain.js</strong>里面调用了该方法。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;先打开main.js,继承自basemain.js,在GetSubMenus()里面通过<code>handler: function () { me.OnMenuClick(menu); }</code>来调用的,这个看方法名就跟点击没啥大关系;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;那在打开<strong>hmain.js</strong>吧,果然,它重写覆盖了<code>OnCretaeMenu()</code>方法,在该方法里通过:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">listeners: &#123;</div><div class="line">  &apos;itemclick&apos;: function (view, record) &#123;</div><div class="line">    me.OnMenuClick(record.data);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>调用<code>OnMenuClick()</code>方法来实现对<code>tranPrefix</code>赋值。(一个方法套着一个方法,找起来确实麻烦)<br><strong>还记得<code>OnCretaeMenu()</code>方法在哪里调用的吗？重新看basemain.js,在构造函数里就调用了哦。</strong></p>
<blockquote>
<p><code>tranPrefix</code>赋值我们知道了,可是才打开冰山一角,继续分析<code>tools.SetToolbar()</code>,通过<code>var sauth = tools.GetAuth(mcode)</code>得到<code>sauth</code>,然后调用<code>tools.DeleteToolbarItemByAuth(sauth, items, mcode + &#39;btnAdd&#39;, 2, tools.ValidSeparator(sauth, 14));</code></p>
</blockquote>
<p><a id="314">tools.DeleteToolbarItemByAuth()</a>方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">tools.DeleteToolbarItemByAuth = function (auth, items, id, idx, separator) &#123;</div><div class="line">	  if (!tools.ValidMenuAuth(auth, idx)) &#123;</div><div class="line">	    for (var i = 0; i &lt; items.length; i++) &#123;</div><div class="line">	      if (items[i].id &amp;&amp; (items[i].id == id)) &#123;</div><div class="line">	        if (i &lt; items.length) &#123;</div><div class="line">	          items.remove(i);</div><div class="line">	          if (i &gt; 0)</div><div class="line">	            items.remove(i - 1);</div><div class="line">	          if (separator &amp;&amp; (i &gt; 1))</div><div class="line">	            items.remove(i - 2);</div><div class="line">	        &#125;</div><div class="line">	        break;</div><div class="line">	      &#125;</div><div class="line">	    &#125;</div><div class="line">	  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个方法开头调用<code>tools.ValidMenuAuth(auth, idx)</code>,该方法默认返回false。这一步应该是进行删除按钮。通过传入的<code>tranPrefix</code>来进行删除按钮(其实就是通过权限值来控制按钮的删除)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>me.tbGrid.add(toolbar1)</code>这一步就是把需要的按钮加入页面展示。</p>
</blockquote>
<p><strong>OnBeforeFormLoad()先到此为止,接下来就是<a id="32">OnBeforeCreateEdit()</a>了</strong><br><strong><a href="#1">返回目录</a></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">OnBeforeCreateEdit:function()&#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = this.tranPrefix;</div><div class="line">  var nowdate=new Date();</div><div class="line">  var attritems = [</div><div class="line">    &apos; &apos;, </div><div class="line">    &#123; </div><div class="line">        xtype: &apos;textfield&apos;, </div><div class="line">        fieldLabel: &apos;项目编号检索&apos;,    // 对应下图2 试验基地名称 字段位置(图与代码并不一致请注意)</div><div class="line">        labelWidth: 100,              // 对应下图2 试验基地名称 字段长度(图与代码并不一致请注意)</div><div class="line">        width: 220,                   // 对应下图2 试验基地名称 字段后面的 输入框 长度(图与代码并不一致请注意)</div><div class="line">        maxLength: 12,                // 对应下图2 试验基地名称 字段后面的 输入框 允许输入的最大长度(图与代码并不一致请注意)</div><div class="line">        name: &apos;searchprojectid&apos;, </div><div class="line">        id: mep + &apos;searchprojectid&apos;, </div><div class="line">        allowBlank: true              // 允许有空值</div><div class="line">    &#125;,</div><div class="line">    &apos; &apos;, </div><div class="line">    &#123; </div><div class="line">      text: gpersist.STR_BTN_SEARCH,  // 查询按钮文字</div><div class="line">      iconCls: &apos;icon-find&apos;,           // 查询按钮图标</div><div class="line">      handler: me.OnPrdIdSearch,      // 触发查询方法</div><div class="line">      scope: me                       // 作用域</div><div class="line">    &#125;</div><div class="line">  ];</div><div class="line">  // 类似下图</div><div class="line">  var attr = Ext.create(&apos;Ext.ux.GridPicker&apos;, &#123;</div><div class="line">    fieldLabel: tools.MustTitle(&apos;项目编号&apos;),      // 搜索框对应的名称(类似下图1的&apos;试验基地名称&apos;)</div><div class="line">    name: &apos;project.projectid&apos;, </div><div class="line">    id: mep + &apos;projectid&apos;, </div><div class="line">    winTitle: &apos;项目编号&apos;,                          // 搜索弹出框的标题(类似下图2的&apos;试验基地&apos;)</div><div class="line">    maxLength: 20,                                // 输入框允许输入最大长度</div><div class="line">    maxLengthText: &apos;项目编号长度不能超过20个字符！&apos;, // 输入框提示</div><div class="line">    selectOnFocus: false,                         // 这个属性应该是选择框聚焦</div><div class="line">    labelWidth: 120,                              // 类似下图1&apos;试验基地名称&apos;这段字的长度(出现折行说明长度不够)</div><div class="line">    blankText: &apos;项目编号不能为空！&apos;,                // 提示不为空</div><div class="line">    allowBlank: false,                            // 不允许有空值</div><div class="line">    anchor: &apos;100%&apos;,                                 </div><div class="line">    tabIndex: 3,                                  </div><div class="line">    editable: false,                              </div><div class="line">    columnUrl: &apos;SysSqlColumn.do?sqlid=p_get_projectid&apos;, // 搜索弹出框列表列名</div><div class="line">    storeUrl: &apos;SearchProjectid&apos;,                        // 搜索弹出框数据获取接口</div><div class="line">    hasPage: true,                                </div><div class="line">    pickerWidth: 800, </div><div class="line">    pickerHeight: 450, </div><div class="line">    searchTools: attritems                        // 对应下图2 试验基地名称以及查询按钮一行(图与代码并不一致请注意)</div><div class="line">  &#125;);</div><div class="line">  me.editControls=[</div><div class="line">    &#123;</div><div class="line">      xtype:&apos;container&apos;,anchor:&apos;100%&apos;,layout:&apos;column&apos;, items:[</div><div class="line">        &#123; xtype:&apos;container&apos;,columnWidth:.5,layout:&apos;anchor&apos;, items:[</div><div class="line">            tools.FormText(&apos;项目名称&apos;, &apos;project.projectname&apos;, mep+&apos;projectname&apos;, 20, &apos;96%&apos;, false, 1, null, 100)</div><div class="line">        ]&#125;,</div><div class="line">        &#123;xtype:&apos;container&apos;,columnWidth:.5,layout:&apos;anchor&apos;, items:[</div><div class="line">        	  attr</div><div class="line">			  ]&#125;,</div><div class="line">      ]</div><div class="line">    &#125;,</div><div class="line">    tools.FormTextArea(&apos;备注&apos;,&apos;project.remark&apos;,mep+&apos;remark&apos;,400,&apos;100%&apos;,false,20,5,100),</div><div class="line">    &#123;xtype:&apos;hiddenfield&apos;,name:&apos;project.deal.action&apos;,id: mep + &apos;datadeal&apos; &#125;,</div><div class="line">  ];</div><div class="line">  me.disNews = [&apos;projectname&apos;];                                // 不能新增</div><div class="line">  me.disEdits = [&apos;projectname&apos;];                               // 不能编辑</div><div class="line">  me.enNews = [&apos;projectid&apos;];                               // 能新增</div><div class="line">  me.enEdits = [&apos;projectid&apos;];                              // 能编辑</div><div class="line">  attr.on(&apos;griditemclick&apos;, me.OnPrdIdSelect, me);            // 给搜索框绑定选择方法</div><div class="line">  attr.on(&apos;gridbeforeload&apos;, me.OnPrdIdBeforeLoad, me);       // 给搜索框绑定加载方法</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<blockquote>
<p><code>attr</code>类似下图</p>
</blockquote>
<p><img src="../../../../images/ext_search.png" alt=""><br><img src="../../../../images/ext_search2.png" alt=""></p>
<hr>
<p><strong>具体的tools.FormText()等方法可自行查看,一般最后一个参数代表字段长度,不是输入框哦</strong></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>{xtype:&#39;hiddenfield&#39;,name:&#39;project.deal.action&#39;,id: mep + &#39;datadeal&#39; },</code>这一段代码代表隐藏,点击保存按钮时依然会向后台传参数。如果以后有后台需要但是前台并不需要展示的字段可以使用这种写法,如果采用该写法就不需要把相同的字段写在在<code>items:[]</code>里面了。</p>
</blockquote>
<p><strong>主要看<a id="321">OnPrdIdSelect(),OnPrdIdBeforeLoad()以及OnPrdIdSearch()</a>方法</strong><br><strong><a href="#1">返回目录</a></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// 选择框并且设置值</div><div class="line">OnPrdIdBeforeLoad: function () &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = this.tranPrefix;</div><div class="line">  var prdid = Ext.getCmp(mep + &apos;projectid&apos;);    </div><div class="line">	if (prdid.store) &#123;</div><div class="line">	  prdid.store.on(&apos;beforeload&apos;, function (store, options) &#123;      </div><div class="line">		  Ext.apply(store.proxy.extraParams, &#123;</div><div class="line">		    &apos;project.projectid&apos;: tools.GetValueEncode(mep + &apos;searchprojectid&apos;) </div><div class="line">		  &#125;);</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line">&#125;,  </div><div class="line">OnPrdIdSelect: function (render, item) &#123;</div><div class="line">  var me = this;</div><div class="line">	var mep = this.tranPrefix;</div><div class="line">//  console.log(&quot;item3&quot;,item);</div><div class="line">	if (item &amp;&amp; !Ext.isEmpty(item.projectid)) &#123;</div><div class="line">	  tools.SetValue(mep + &apos;projectid&apos;, item.projectid);</div><div class="line">		tools.SetValue(mep + &apos;projectname&apos;, item.projectname);</div><div class="line">	&#125;</div><div class="line">&#125;,</div><div class="line">OnPrdIdSearch: function () &#123;</div><div class="line">	var me = this;</div><div class="line">	var mep = this.tranPrefix;</div><div class="line">	me.OnPrdIdBeforeLoad();</div><div class="line">	var prdid = Ext.getCmp(mep + &apos;projectid&apos;);</div><div class="line">	prdid.store.loadPage(1);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;经过测试发现,先调用的是<code>OnPrdIdBeforeLoad()</code>,与我先前所预料的<code>OnPrdIdSearch()</code>不一致。先调用了<code>OnPrdIdBeforeLoad()</code>方法把<code>search</code>接口查到的数据展示在列表上,然后调用了<code>OnPrdIdSelect()</code>方法进行赋值,可以发现页面上的确有值保存成功。我将<code>OnPrdIdSearch()</code>注释掉也丝毫没问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Ext.apply(store.proxy.extraParams, &#123;</div><div class="line">  &apos;project.projectid&apos;: tools.GetValueEncode(mep + &apos;searchprojectid&apos;) </div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>prdid.store.on(&#39;beforeload&#39;, function (store, options) {...}</code>,这段代码其实给<code>store</code>加了一个<code>beforeload</code>监听事件。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>OnPrdIdBeforeLoad()</code>中的上段代码其实是将<code>&#39;project.projectid&#39;</code>属性及属性值拷贝给<code>store.proxy.extraParams</code>对象。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>但是,经过我测试发现,打印<code>prdid.store</code>居然是<code>undefined</code>！！！(我测试时搜索弹出框里面的数据少且没有分页)我试着将<code>OnPrdIdBeforeLoad()</code>里面从<code>var prdid</code>以及<code>if</code>判断全部隐藏,发现没有报错且能正常赋值显示,所以暂时并不清楚它到底干嘛的。</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;而<code>OnPrdIdSelect</code>则是在双击选中时调用,我打印了<code>item</code>,发现该对象里面的属性以及属性值与<code>search</code>接口返回的对应的该条数据一样。但是我们并不清楚它是如何做到的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这时候我们需要回过去看<code>attr.on(&#39;griditemclick&#39;, me.OnPrdIdSelect, me);</code>这段代码,经过百度发现这段代码其实是给<code>attr</code>框里面的单行添加了双击绑定事件,即双击某一行调用<code>OnPrdIdSelect()</code>方法;但是我们仍然没有看到它是如何传参的,那就继续呗。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;紧接着我打印了<code>render</code>发现是一个<code>constructor()</code>,其实就是<code>attr</code>。</p>
<hr>
<p>接下来看看<a id="322">OnInitData()</a>方法<br><strong><a href="#1">返回目录</a></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">OnInitData : function() &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = me.tranPrefix;</div><div class="line">  console.log(&apos;OnInitData&apos;)</div><div class="line">  me.callParent(arguments);</div><div class="line">  tools.SetValue(mep + &apos;projectid&apos;, &apos;1&apos;);</div><div class="line">  tools.SetValue(mep + &apos;projectname&apos;, &apos;1&apos;);</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<blockquote>
<p>该方法其实是用来初始化赋值的即刚进入页面某些字段就要有初始值。<strong>但是该方法应该在接下来的<code>OnLoadData()</code>调用,不然无法赋值。</strong></p>
</blockquote>
<p>看看父类<strong>busform.js</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">OnInitData : function() &#123;</div><div class="line">  var me = this;</div><div class="line">  me.plEdit.getForm().reset();</div><div class="line">  me.OnDetailRefresh();</div><div class="line">&#125;,</div><div class="line">OnDetailRefresh : function() &#123;</div><div class="line">  var me = this;    </div><div class="line">  if (me.plDetailGrid &amp;&amp; me.plDetailGrid.store)</div><div class="line">    me.plDetailGrid.store.load();</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;父类调用了两个方法,一个重置,另一个刷新。<code>me.plDetailGrid.store.load()</code>经过搜索应该是Ext自带的方法,用来与后台交互获取数据加载页面。单独来看的话不容易观察,接下来先看<code>OnFormLoad()</code>方法。</p>
<h3 id="OnFormLoad-方法"><a href="#OnFormLoad-方法" class="headerlink" title="OnFormLoad()方法"></a><a id="323">OnFormLoad()</a>方法</h3><p><strong><a href="#1">返回目录</a></strong></p>
<blockquote>
<p>该方法用来加载主页面,算是页面主体方法了。</p>
</blockquote>
<p>busform.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">  // 加载主页面</div><div class="line">OnFormLoad : function() &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = me.tranPrefix;</div><div class="line">  var date = new Date();</div><div class="line">  var mainpanel = Ext.getCmp(&apos;tpanel&apos; + me.mid);</div><div class="line">  if (!Ext.isDefined(mainpanel))</div><div class="line">    return;</div><div class="line">  mainpanel.removeAll();</div><div class="line">  tools.log(&apos;OnFormLoad1&apos;, date);</div><div class="line">  // 生成列表的字段属性</div><div class="line">  me.columns = [];</div><div class="line">  me.fields = []; </div><div class="line">  tools.GetGridColumnsByUrl(this.columnUrl, me.columns, me.fields, mep + &apos;_l_&apos;); </div><div class="line">  me.gridStore = tools.CreateGridStore(tools.GetUrl(this.storeUrl), me.fields);</div><div class="line">  // 加载主页面前</div><div class="line">  me.OnBeforeFormLoad();</div><div class="line">  tools.log(&apos;OnFormLoad2&apos;, date);</div><div class="line">  // 生成列表</div><div class="line">  me.plGrid = Ext.create(&apos;Ext.grid.Panel&apos;, &#123;</div><div class="line">    id : mep + &apos;grid&apos;,</div><div class="line">    region : &apos;center&apos;,</div><div class="line">    frame : false,</div><div class="line">    border : false,</div><div class="line">    margins : &apos;0 0 0 0&apos;,</div><div class="line">    padding : &apos;0 0 0 0&apos;,suspendLayout: false,</div><div class="line">    loadMask : true,</div><div class="line">    columnLines : true,</div><div class="line">    viewConfig : &#123;</div><div class="line">      autoFill : true,</div><div class="line">      stripeRows : true</div><div class="line">    &#125;,</div><div class="line">    columns : me.columns,</div><div class="line">    store : me.gridStore,</div><div class="line">    tbar : me.tbGrid,</div><div class="line">    enableColumnMove: false,// suspendLayout:true,//延时操作，不去掉的话column不能拖动</div><div class="line">    selModel: me.hasGridSelect ? new Ext.selection.CheckboxModel(&#123; injectCheckbox: 1 &#125;) : &#123;&#125;,</div><div class="line">    listeners : &#123;</div><div class="line">      &apos;itemdblclick&apos; : &#123; fn : me.OnShow, scope : me &#125;,</div><div class="line">      &apos;itemclick&apos; : &#123; fn : me.OnItemClick, scope : me &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  // 分页处理</div><div class="line">  if (me.hasPage) &#123;</div><div class="line">    me.plGrid.insertDocked(0, Ext.create(&apos;Ext.PagingToolbar&apos;, &#123;</div><div class="line">      store : me.gridStore,</div><div class="line">      displayInfo : true,</div><div class="line">      displayMsg : gpersist.STR_PAGE_FMT,</div><div class="line">      emptyMsg : gpersist.STR_NO_DATA, suspendLayout: true,</div><div class="line">      dock : &apos;bottom&apos;</div><div class="line">    &#125;));</div><div class="line">  &#125;</div><div class="line">  // 主界面生成后处理</div><div class="line">  me.OnAfterFormLoad();</div><div class="line">  tools.log(&apos;OnFormLoad2&apos;, date);</div><div class="line">  // 建立编辑界面</div><div class="line">  me.OnCreateEditWin();</div><div class="line">  tools.log(&apos;OnFormLoad3&apos;, date);</div><div class="line">  var pleditview = Ext.create(&apos;Ext.Panel&apos;, &#123;</div><div class="line">    frame : false,</div><div class="line">    autoScroll : false,</div><div class="line">    region : &apos;center&apos;,</div><div class="line">    border : false,</div><div class="line">    layout : &apos;border&apos;,</div><div class="line">    margins : &apos;0 0 0 0&apos;,</div><div class="line">    padding : &apos;0 0 0 0&apos;</div><div class="line">  &#125;);</div><div class="line">  if (me.hasEdit)</div><div class="line">    pleditview.add(me.plEdit);</div><div class="line">  if (me.hasDetail) &#123;</div><div class="line">    if (me.plDetail &amp;&amp; !me.hasEdit)</div><div class="line">      me.plDetail.region = &apos;center&apos;;</div><div class="line">    pleditview.add(me.plDetail);</div><div class="line">  &#125;</div><div class="line">  tools.log(&apos;OnFormLoad4&apos;, date);</div><div class="line">  me.tabMain = Ext.create(&apos;Ext.tab.Panel&apos;, &#123;</div><div class="line">    border : false,</div><div class="line">    activeTab : 0,</div><div class="line">    bodyBorder : false,</div><div class="line">    defaults : &#123;</div><div class="line">      bodyStyle : &apos;border:0px;padding:0px;&apos;</div><div class="line">    &#125;,</div><div class="line">    margins : &apos;0 0 0 0&apos;,</div><div class="line">    region : &apos;center&apos;,</div><div class="line">    deferredRender : me.deferredRender,</div><div class="line">    items : [me.plGrid, pleditview]</div><div class="line">  &#125;);</div><div class="line">  tools.log(&apos;OnFormLoad6&apos;, date);</div><div class="line">  me.tabMain.getTabBar().setVisible(false);</div><div class="line">  tools.log(&apos;OnFormLoad5&apos;, date);</div><div class="line">  mainpanel.add(me.tabMain);</div><div class="line">  tools.log(&apos;OnFormLoad7&apos;, date);</div><div class="line">  if (me.hasAutoLoad)</div><div class="line">    me.OnSearch();</div><div class="line">  tools.log(&apos;OnFormLoad8&apos;, date);</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>baseform.js<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">constructor : function(config) &#123;</div><div class="line">  var me = this;</div><div class="line">  me.callParent(arguments);</div><div class="line">  me.OnInitConfig();</div><div class="line">  Ext.apply(me, config);</div><div class="line">  me.sauth = tools.GetMenuAuth(me.tranPrefix);</div><div class="line">  tools.GetParams(me.selectParams);</div><div class="line">  me.OnFormLoad();</div><div class="line">&#125;,</div><div class="line">OnFormLoad : function() &#123;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先,<strong>busform.js</strong>继承自<strong>baseform.js</strong>,所以先去<strong>baseform.js</strong>看有没有<code>OnFormLoad()</code>。观察上面的代码发现<strong>baseform.js</strong>里的确定义了<code>OnFormLoad()</code>方法但是里面什么都没有,专门用来给子类重写覆盖的。而且是在<code>constructor()</code>里面直接调用的,即页面一加载就调用该方法了。(或者说实例化一个对象就调用了该方法)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;现在再看看<strong>busform.js</strong>以及它的继承者,发现几乎就是copy。</p>
<ul>
<li><code>var mainpanel</code>这一步就是在创建主面板(类似画画一样,先弄个面板出来)</li>
<li><code>mainpanel.removeAll()</code>这一步是为了以防万一,先清空面板为接下来画页面做准备。</li>
<li><code>tools.GetGridColumnsByUrl(this.columnUrl, me.columns, me.fields, mep + &#39;_l_&#39;)</code>这一步调用tools工具里面的方法,代码较长不列出来,其实主要是调接口接收数据,然后给<code>me.columns</code>与<code>me.fields</code>赋值,用于接下来创建列表列名。</li>
<li>然后是<code>tools.CreateGridStore(tools.GetUrl(this.storeUrl), me.fields)</code>,我把<code>CreateGridStore()</code>方法的代码列在下面。其中<code>Ext.data.JsonStore</code>是自带的方法,继承自<code>Ext.data.Store</code>。我打印了<code>me.gridStore</code>发现是一个<code>constructor()</code>。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">tools.CreateGridStore = function (url, fields, pagesize) &#123;</div><div class="line">  var size = pagesize || 20;</div><div class="line">  return new Ext.data.JsonStore(&#123;</div><div class="line">    proxy: &#123;</div><div class="line">      type: &apos;ajax&apos;,</div><div class="line">      url: url,</div><div class="line">      timeout: 180000,</div><div class="line">      reader: &#123;</div><div class="line">        type: &apos;json&apos;,</div><div class="line">        root: &apos;data&apos;,           // 表示从后台传过来的json数据</div><div class="line">        totalProperty: &apos;total&apos;  // 表示结果数</div><div class="line">      &#125;</div><div class="line">    &#125;,</div><div class="line">    autoLoad: false,</div><div class="line">    sortOnLoad: true,</div><div class="line">    fields: fields,             // 对象数组集合</div><div class="line">    pageSize: size</div><div class="line">  &#125;);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<ul>
<li>接下来调用<code>OnBeforeFormLoad()</code>方法,前面有讲过。</li>
<li><code>me.plGrid</code>用于生成列表,之前有碰到过需求页面上不要列表,直接可编辑。其实就在这里给它注释掉,当然,下面的<code>me.tabMain</code>里面的<code>items</code>也要把<code>plGrid</code>删掉。<br>需要注意的是里面有一个<code>listeners</code>,这是一个监听器功能。</li>
<li>然后是<code>OnAfterFormLoad()</code>方法。父类里面并没有定义内容,只是可以被继承重写。</li>
<li>之后是建立调用<code>OnCreateEditWin()</code>方法编辑页面。</li>
<li><code>var pleditview</code>这个画的看图说话吧,语言有时候并没有图好。(我这里直接修改<code>me.tabMain</code>里面的<code>items</code>,同时删掉<code>plGrid</code>情况下的对比图)</li>
</ul>
<p>有<code>pleditview</code><br><img src="../../../../images/ext_pleditview.png" alt=""><br>无<code>pleditview</code><br><img src="../../../../images/ext_pleditview2.png" alt=""></p>
<ul>
<li><code>me.tabMain</code>其实对应上图无<code>pleditview</code>的空白面板</li>
<li><code>me.tabMain.getTabBar().setVisible(false)</code>这一步注释掉页面会变得很难看。字面理解是把<strong>TabBar</strong>隐藏掉,实际上,按钮依然出现但是。。。看图吧</li>
</ul>
<p><img src="../../../../images/ext_tabBar.png" alt=""></p>
<ul>
<li><code>mainpanel.add(me.tabMain)</code>这一步其实是把页面加到整个系统界面上,不然点击目录没反应。</li>
<li>有时候,我们在列表页点击新增时某些自断是不给填写设置的默认值,这时候需要我们紧接着调用<code>me.OnLoadData(record);</code>以及<code>me.OnInitData();</code>两个方法,不能变换位置,否则发现页面上没有默认值。</li>
</ul>
<p>接下来看看<a id="324">OnLoadData()</a>方法<br><strong><a href="#1">返回目录</a></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// busform.js</div><div class="line">OnLoadData: function (record) &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = me.tranPrefix;</div><div class="line">  if (!Ext.isEmpty(eval(&apos;record.&apos; + me.idPrevNext))) &#123;        </div><div class="line">    return me.OnSetData(eval(&apos;record.&apos; + me.idPrevNext), record);</div><div class="line">  &#125; else &#123;</div><div class="line">    me.dataDeal == gpersist.DATA_DEAL_SELECT;</div><div class="line">    tools.alert(Ext.String.format(gpersist.STR_FMT_NOLOAD, me.editInfo));</div><div class="line">  &#125;</div><div class="line">  return false;</div><div class="line">&#125;,</div><div class="line">// 某继承者</div><div class="line">OnLoadData:function(item)&#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = me.tranPrefix;</div><div class="line">  // item 里的属性对应 T_Set_Sql_Column 表里设置的属性,如果发现补全就补全或者类似下面注释的方法重新调接口获取</div><div class="line">  // var item = tools.JsonGet(tools.GetUrl(&apos;接口?project.projectid=&apos;) + item.projectid);</div><div class="line">  // console.log(item)</div><div class="line">  var curDate = new Date()</div><div class="line">	//格式化;</div><div class="line">	var time=Ext.Date.format(curDate, &apos;Y-m-d H:i:s&apos;);</div><div class="line">  if (item &amp;&amp; !Ext.isEmpty(item.projectid)) &#123;</div><div class="line">    tools.SetValue(mep+&apos;projectid&apos;,item.projectid);</div><div class="line">    tools.SetValue(mep+&apos;projectname&apos;,item.projectname);</div></pre></td></tr></table></figure>
<blockquote>
<p>当双击某条数据去查看详情时会发现有些字段没有值,主要是因为<code>item</code>里的属性对应 T_Set_Sql_Column 表里设置的属性,如果发现补全就补全或者类似下面注释的方法重新调接口获取</p>
</blockquote>
<h3 id="附件相关学习"><a href="#附件相关学习" class="headerlink" title="附件相关学习"></a><a id="325">附件相关学习</a></h3><p><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;首先,附件相关是有通用代码的,在<strong>busform.js</strong>,待会详细学习,开发过程中把代码完全copy过来有时候并不能用,这时候我们自己必须要去慢慢找原因,所以还是理解下比较好。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;主要是从<code>OnCreateEditWin()</code>开始的,代码较多就不贴了。也用到了<code>OnShowDetail()</code>,<code>OnListDeleteLeft()</code>,<code>OnListNewLeft()</code>,<code>OnCreateWinLeft()</code>,<code>OnDownLoad()</code>和<code>OnCloseWin()</code>以及<code>lookpic()</code>方法,但是父类并没有。据前辈们说,这里用了第三方插件。</p>
<ul>
<li><code>OnBeforeCreateEditToolBar()</code>和<code>OnAfterCreateEditToolBar()</code>以及<code>OnAfterCreateEdit()</code>方法并没有什么内容</li>
<li><code>me.editToolItems</code>定义了页面<strong>ToolBar</strong>上的按钮,然后通过<code>tools.SetEditToolbar()</code>控制权限对按钮进行增删保留。</li>
<li><code>me.tbEdit</code>创建<strong>Toolbar</strong>一栏(面板)</li>
<li>之后调用<code>me.OnBeforeCreateEdit()</code>方法建立编辑页面内容</li>
<li>这里的<code>me.plEdit</code>我给他注释掉发现控制台报<code>Cannot read property &#39;getForm&#39; of null</code>,且主界面没有了,附件页面放大占领了主界面原来位置。</li>
<li>父类里紧接着判断<code>me.hasDetail</code>是否为true,true的话才会创建面板在页面上显示。我试着把继承者<code>hasDetail</code>属性设置为false,发现页面如图所示：</li>
</ul>
<p><img src="../../../../images/ext_hasDetail.png" alt=""></p>
<ul>
<li>经过<code>tools.GetGridColumnsByUrl()</code>方法,<code>me.columnDetails</code>从后台接收到数据已经不是空数组了。接下来的<code>Ext.each()</code>方法对列名数组进行遍历,判断是不是checkbox类型的列,如果是的话,给该列绑定一个<code>beforecheck</code>事件,然后给对应的checkbox改变选中状态。</li>
<li><p><code>me.cellEditing</code>这里创建了<strong>cellEditing</strong>面板,<code>clicksToEdit</code>属性代表<strong>单击几次进入编辑</strong>,父类设置的是<strong>1</strong>,即单击一次即可进入编辑。<br><code>listeners</code>属性代表绑定监听事件。<code>edit</code>事件绑定了刷新;<code>beforeedit</code>事件绑定函数内部有一个判断,如果<code>me.dataDeal == gpersist.DATA_DEAL_SELECT</code>返回<strong>false</strong>或者调用<code>me.OnBeforeDetailEdit(e, editor)</code>,然后看了下<code>OnBeforeDetailEdit()</code>直接就返回<strong>false</strong>没有任何操作。。。<br>所以个人认为这里的<code>beforeedit</code>事件要么返回<strong>false</strong>要么没有返回值。<br>我在继承者页面里面并没有找到该段代码,隐藏父类该段代码也没有明显变化,且页面无报错。</p>
</li>
<li><p>父类接下来是<code>me.plDetailGrid</code>对象,该对象应该是一个模板,继承者页面命名可以与其不一致。</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">// 附件面板</div><div class="line">me.plDetailGrid = Ext.create(&apos;Ext.grid.Panel&apos;, &#123;</div><div class="line">  id : mep + &apos;detailgrid&apos;,</div><div class="line">  region : &apos;center&apos;,</div><div class="line">  title : me.detailTitle,       // 附件面板标题</div><div class="line">  autoScroll : true,            // 自动滚屏</div><div class="line">  frame : false,                // 为true时边框为圆角且具有背景色</div><div class="line">  border : false,</div><div class="line">  margins : &apos;0 0 0 0&apos;,</div><div class="line">  padding : &apos;0 0 0 0&apos;,</div><div class="line">  loadMask : true,              // 加载数据时为元素做出类似于遮罩的效果</div><div class="line">  columnLines : true,           // 如果改为false看下图</div><div class="line">  viewConfig : &#123;</div><div class="line">    autoFill : true,            // 当行大小变化时始终填充满</div><div class="line">    stripeRows : true           // 在表格中显示斑马线</div><div class="line">  &#125;,</div><div class="line">  features : [</div><div class="line">    &#123; ftype : &apos;summary&apos; &#125;       // 百度了小,貌似是表格汇总属性</div><div class="line">  ],</div><div class="line">  columns : me.columnDetails,   // 列名</div><div class="line">  store : me.gridDetailStore,   // 后台返回的数据</div><div class="line">  selModel: me.hasDetailGridSelect ? new Ext.selection.CheckboxModel(&#123; injectCheckbox: 1, checkOnly: true &#125;) : &#123;&#125;,</div><div class="line">  plugins: plugins,             // 可以没有,发现继承者页面就没有。。。应该是扩展插件的意思</div><div class="line">  listeners : &#123;</div><div class="line">    &apos;itemdblclick&apos; : &#123; fn : me.OnListSelect, scope : me &#125;   // 监听点击事件调用OnListSelect()方法</div><div class="line">  &#125;        </div><div class="line">&#125;);</div><div class="line">// busform.js</div><div class="line">OnListSelect: function(e, record, item, index) &#123;</div><div class="line">  var me = this;</div><div class="line">  me.detailRecord = record;</div><div class="line">  if (!me.winDetail)                            // 如果winDetail面板不存在,调用OnCreateDetailWin()方法</div><div class="line">    me.OnCreateDetailWin();</div><div class="line">  if(me.winDetail &amp;&amp; record) &#123;                  // 如果winDetail面板存在并且record也存在,显示winDetail面板</div><div class="line">    me.winDetail.show();</div><div class="line">    me.detailEditType = 2;                      // 2对应着修改</div><div class="line">    me.OnLoadDetailData(record.data);           // 父类定义了该方法但没有内容</div><div class="line">    me.OnAuthDetailEditForm(true);              // 这个方法管理页面上的按钮是否起作用</div><div class="line">  &#125;</div><div class="line">&#125;,</div><div class="line">OnAuthDetailEditForm : function(islayout) &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = this.tranPrefix;</div><div class="line">  if (islayout)</div><div class="line">    me.plDetailEdit.suspendLayouts();           // Ext 自带的禁用重绘功能。为了大数据量Grid做数据移除和添加而优化提高效率</div><div class="line">  switch (me.dataDeal) &#123;</div><div class="line">    case gpersist.DATA_DEAL_SELECT:</div><div class="line">         tools.FormDisable(me.disDetailControls, me.enDetailControls, mep); // 禁止编辑输入框,只读</div><div class="line">         tools.BtnsDisable([&apos;btnDetailSave&apos;], mep);  // 禁用按钮    </div><div class="line">         break;</div><div class="line">    default:</div><div class="line">         tools.FormInit(me.disDetailControls, me.enDetailControls, mep);</div><div class="line">         tools.BtnsEnable([&apos;btnDetailSave&apos;], mep);</div><div class="line">         break;</div><div class="line">  &#125; </div><div class="line">  if (islayout) &#123;</div><div class="line">    me.plDetailEdit.resumeLayouts(true);       // Ext 自带的开启重绘功能</div><div class="line">    me.plDetailEdit.doLayout();                // Ext 自带的重绘</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p><img src="../../../../images/ext_columnline.png" alt=""></p>
<blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;看了下<code>OnListSelect()</code>方法,父类的意思应该是当点击附件列表时进入详情页可以编辑修改。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不过我看了继承者页面,发现它并没有使用该方法反而重写了一个方法<code>lookpic()</code>,用来点击预览的。据徐冬冬说,这个用了第三方插件。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">lookpic: function (view, record) &#123;</div><div class="line">  项目名.PopupFileShow(&apos;预约附件预览&apos;, &apos;接口&apos;, record.data.attachurl, record.data.attachname);</div><div class="line">&#125;,</div><div class="line">// tools.js</div><div class="line">tools.GetPopupWindow = function (namespace, cname, config) &#123;</div><div class="line">  var classname = namespace + &apos;.&apos; + cname;</div><div class="line">  var win;</div><div class="line">  if (eval(classname)) &#123;</div><div class="line">    win = Ext.create(classname, config);</div><div class="line">  &#125;</div><div class="line">  else &#123;</div><div class="line">    Ext.Ajax.request(&#123;</div><div class="line">      url: &apos;地址&apos; + cname + &apos;.js&apos;,</div><div class="line">      async: false,</div><div class="line">      method : &apos;GET&apos;,</div><div class="line">      success: function (response, opts) &#123;</div><div class="line">        eval(response.responseText);          </div><div class="line">      &#125;,</div><div class="line">      failure: function (response) &#123; &#125;</div><div class="line">    &#125;);</div><div class="line">    win = Ext.create(classname, config);</div><div class="line">  &#125;</div><div class="line">  return win;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>PopupFileShow()</code>方法里调用了<code>tools.GetPopupWindow()</code>方法返回了Ext对象并且调用<code>OnSetData()</code>方法。</p>
</blockquote>
<ul>
<li><code>me.deitems</code>定义了<code>me.plDetailGrid</code>面板按钮,然后通过<code>me.plDetailGrid.insertDocked(0, tbdetailedit)</code>把刚刚定义的按钮添加到<code>me.plDetailGrid</code>面板里。然后判断<code>me.hasPageDetail</code>是否为true,是的话在列表页面底部插入分页。<br><strong>这里我感觉很奇怪,明明在<code>OnFormLoad()</code>里有分页控制了,这里为什么还需要呢?看了下继承者页面并没有该段代码,注释掉父类也没报错,页面显示正常。</strong></li>
<li><code>detailTabs</code>属性只在<strong>busform.js</strong>里面找到,默认值是1,查了下可能是控制tab页打开数量的。然后看了下继承者页面,直接没要这个判断,然后把所有面板放到<code>me.plDetail.items</code>属性里,这样页面上就有多个附件面板展示了。看下图：</li>
</ul>
<p><img src="../../../../images/ext_detailTabs.png" alt=""></p>
<h3 id="附上上传附件通用代码"><a href="#附上上传附件通用代码" class="headerlink" title="附上上传附件通用代码"></a><a id="326">附上上传附件通用代码</a></h3><p><strong><a href="#1">返回目录</a></strong></p>
<blockquote>
<p>贴上主要的附件代码,防止忘记。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line">// 点击上传时调用</div><div class="line">OnShowDetail: function(render, item)&#123;   </div><div class="line">	var me = this;</div><div class="line">	var mep = me.tranPrefix;</div><div class="line">  //  console.log(&apos;1010101010,OnShowDetail&apos;);</div><div class="line">	console.log(me.plCheckGrid.store.getAt(0));</div><div class="line">	console.log(item);</div><div class="line">	var newreord = me.plCheckGrid.store.model.create(&#123;&#125;);</div><div class="line">	newreord.data.attachname = item.name;</div><div class="line">	newreord.data.attachurl = item.url;</div><div class="line">	//判断是否是图片</div><div class="line">	if(&apos;.jpg&apos;==item.type||&apos;.png&apos;==item.type||&apos;.gif&apos;==item.type)&#123;</div><div class="line">		newreord.data.attachtypename=&apos;图片&apos;;</div><div class="line">		newreord.data.attachtype=&apos;1&apos;;</div><div class="line">	&#125;else&#123;</div><div class="line">		newreord.data.attachtypename=&apos;文件&apos;;</div><div class="line">		newreord.data.attachtype=&apos;2&apos;;</div><div class="line">	&#125;</div><div class="line">	me.plCheckGrid.store.insert(me.plCheckGrid.store.getCount(), newreord);</div><div class="line">	me.plCheckGrid.getView().refresh();</div><div class="line">&#125;,</div><div class="line">//关闭图片上传窗口 时调用</div><div class="line">OnCloseWin: function()&#123;</div><div class="line">	var me = this;</div><div class="line">	var mep = me.tranPrefix;</div><div class="line">  //	console.log(&apos;1212121212,OnCloseWin&apos;)</div><div class="line">	me.winLeft.destroy();</div><div class="line">&#125;,</div><div class="line">//图片文件查看 双击文件查看时调用</div><div class="line">lookpic: function (view, record) &#123;</div><div class="line">  //	console.log(&apos;1313131313,lookpic&apos;)</div><div class="line">	console.log(record.data)</div><div class="line">	gmo.PopupFileShow(&apos;预约附件预览&apos;, &apos;接口&apos;, record.data.attachurl, record.data.attachname);</div><div class="line">&#125;,</div><div class="line">// 点击下载时调用</div><div class="line">OnDownLoad:function()&#123;</div><div class="line">	var me = this;</div><div class="line">	var mep = me.tranPrefix;</div><div class="line">	var record = tools.OnGridLoad(me.plCheckGrid, &apos;请选择需要下载的文件！&apos;);</div><div class="line">	var url = tools.GetEncode(tools.GetEncode(record.attachurl));</div><div class="line">	console.log(url);</div><div class="line">	var fileurl = tools.DoAction(tools.GetUrl(&apos;接口?fileurl=&apos;) + url);</div><div class="line">  //	console.log(&apos;url: &apos; + url)</div><div class="line">  //	console.log(fileurl)</div><div class="line">  //	console.log(&apos;1414141414,OnDownLoad&apos;)</div><div class="line">	if(fileurl == &apos;error&apos;)&#123;</div><div class="line">		tools.alert(&apos;当前文件不存在&apos;);</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line">	window.location.href = tools.GetUrl(&apos;接口?fname=&apos;) + fileurl;</div><div class="line">&#125;,</div><div class="line">// 点击删除按钮时调用</div><div class="line">OnListDeleteLeft: function () &#123;</div><div class="line">	var me = this;</div><div class="line">  //	console.log(&apos;1515151515,OnListDeleteLeft&apos;)</div><div class="line">	console.log(me.plCheckGrid.selModel.selected.items[0])</div><div class="line">	var j = me.plCheckGrid.selModel.selected.items.length;</div><div class="line">	for (var i = 0; i &lt; j; i++) &#123;</div><div class="line">		me.plCheckGrid.store.remove(me.plCheckGrid.selModel.selected.items[0]);</div><div class="line">	&#125;</div><div class="line">	me.plCheckGrid.getView().refresh();</div><div class="line">&#125;,</div><div class="line">// 文件选择器 点击新增时调用,在 OnCreateWinLeft 之前</div><div class="line">OnListNewLeft: function () &#123;</div><div class="line">	var me = this;</div><div class="line">  //	console.log(&apos;1616161616,OnListNewLeft&apos;)</div><div class="line">	me.OnCreateWinLeft();</div><div class="line">	if (me.winLeft) &#123;</div><div class="line">		me.winLeft.show();</div><div class="line">	&#125;</div><div class="line">&#125;,</div><div class="line">// 点击新增时调用,在 OnListNewLeft 之后</div><div class="line">OnCreateWinLeft: function () &#123;</div><div class="line">	var me = this;</div><div class="line">	var mep = me.tranPrefix;</div><div class="line">  //	console.log(&apos;17171717,OnCreateWinLeft&apos;)</div><div class="line">	if (Ext.getCmp(mep + &apos;editleft&apos;)) &#123;</div><div class="line">		Ext.getCmp(mep + &apos;editleft&apos;).destroy();</div><div class="line">	&#125;</div><div class="line">	var items = [</div><div class="line">		&apos; &apos;, &#123; id: mep + &apos;btnLeftSave&apos;, text: gpersist.STR_BTN_SAVE, iconCls: &apos;icon-save&apos;, handler: me.OnSaveLeft, scope: me &#125;,</div><div class="line">		&apos;-&apos;, &apos; &apos;, &#123; id: mep + &apos;btnLeftClose&apos;, text: gpersist.STR_BTN_CLOSE, iconCls: &apos;icon-close&apos;, handler: function () &#123; me.winLeft.hide(); &#125; &#125;</div><div class="line">	];</div><div class="line">	var edits = [                 </div><div class="line">		&#123;xtype: &apos;container&apos;, anchor: &apos;100%&apos;, layout: &apos;column&apos;, items: [</div><div class="line">			&#123;xtype: &apos;container&apos;, columnWidth: .5, layout: &apos;anchor&apos;, items: [</div><div class="line">				tools.FormText(&apos;附件名称&apos;, &apos;ifn.filetitle&apos;, mep + &apos;filetitle&apos;, 20, &apos;96%&apos;, false, 1)</div><div class="line">			]&#125;,</div><div class="line">			&#123;xtype: &apos;container&apos;, columnWidth: .5, layout: &apos;anchor&apos;, items: [</div><div class="line">				tools.UploadFile(&apos;上传图片&apos;, &apos;image&apos;, mep+&apos;fileurl&apos;,100, &apos;100%&apos;, true,1)</div><div class="line">			]&#125;</div><div class="line">		]&#125;                  </div><div class="line">	];</div><div class="line">	me.plEditLeft = Ext.create(&apos;Ext.form.Panel&apos;, &#123;</div><div class="line">		id: mep + &apos;pleditleft&apos;,</div><div class="line">		columnWidth: 1,</div><div class="line">		fieldDefaults: &#123;</div><div class="line">			labelSeparator: &apos;：&apos;,</div><div class="line">			labelWidth: gpersist.CON_DEFAULT_LABELWIDTH,</div><div class="line">			labelPad: 0,</div><div class="line">			labelStyle: &apos;font-weight:bold;&apos;</div><div class="line">		&#125;,</div><div class="line">		frame: true,</div><div class="line">		title: &apos;&apos;,</div><div class="line">		bodyStyle: &apos;padding:5px;background:#FFFFFF&apos;,</div><div class="line">		defaultType: &apos;textfield&apos;,</div><div class="line">		closable: false,</div><div class="line">		header: false,</div><div class="line">		unstyled: true,</div><div class="line">		scope: me,</div><div class="line">		tbar: Ext.create(&apos;Ext.toolbar.Toolbar&apos;, &#123; items: items &#125;),</div><div class="line">		items: edits</div><div class="line">	&#125;);</div><div class="line">	var upload = tools.SwfUploadFile();</div><div class="line">	me.winLeft = Ext.create(&apos;Ext.Window&apos;, &#123;</div><div class="line">		id: mep + &apos;editleft&apos;,</div><div class="line">		title: &apos;添加项目附件&apos;,</div><div class="line">		width: 680,</div><div class="line">		height: 160,</div><div class="line">		maximizable: true,</div><div class="line">		closeAction: &apos;hide&apos;,</div><div class="line">		modal: true,</div><div class="line">		layout: &apos;fit&apos;,</div><div class="line">		plain: false,</div><div class="line">		closable: true,</div><div class="line">    //  items: [me.plEditLeft]</div><div class="line">		items: [upload]</div><div class="line">	&#125;);</div><div class="line">	upload.on(&apos;showdetail&apos;,me.OnShowDetail,me);</div><div class="line">	upload.on(&apos;closewin&apos;,me.OnCloseWin,me);</div><div class="line">&#125;,</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="四、踩坑集锦"><a href="#四、踩坑集锦" class="headerlink" title="四、踩坑集锦"></a><a id="4">四、踩坑集锦</a></h3><p><strong><a href="#1">返回目录</a></strong><br>(1).<a id="41">写项目申报时会有附件上传以及预览、下载功能。该功能代码其实直接复制粘贴过来就好了,但是,并不代表直接能用。</a></p>
<ul>
<li>我一开始复制过来时,进行文件上传发现报谷歌浏览器flash版本太低,没事,换360即可。</li>
<li><p>点击上传文件,功能正常,但是我发现列表没有展示。后来发现是<code>OnCreateEditWin()</code>方法里面的<code>urlcolumncaskask</code>不对,对应的<code>sqlid</code>没有。<br><img src="../../../../images/ext_fujian.png" alt=""></p>
</li>
<li><p>当我点击下载按钮时一直报错(当前文件不存在),追踪到<code>OnDownLoad()</code>方法,发现<br><code>var fileurl = tools.DoAction(tools.GetUrl(&#39;Upload接口?fileurl=&#39;) + url);</code>返回的是<strong>error</strong>。然后只能去tools.js里面找<code>GetUrl()</code>和<code>DoAction()</code>方法。<code>GetUrl()</code>只是返回了<code>url</code>,没做出什么改变; <code>DoAction()</code>方法其实是利用ajax调接口,也没有做什么改动,那只能说明接口调用失败。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;期间把变量打印出来,然后在本地看,发现图片并没有保存在该项目内,反而自动新建了个文件夹并保存在新建的文件夹内,很奇怪,问了同事说这是两个项目共用的,都要能看到,然后就没管。但是一直找不到什么原因,当然对框架也不熟。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来陈老师继续出马,发现我图片保存地址不在该项目内,然后项目内全局搜索图片保存的文件夹名(即另一个项目名例如<code>a</code>),发现有几处<code>a</code>,然后把<strong>gpersist.properties</strong>里面的<code>FILE_PATH_BASE</code>值改为当前项目名,结果可以用了。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是,同事说不能这样该配置,不然的话另一个项目就看不到你上传的东西了。。。这就尴尬了。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来陈老师继续出山,帮我看了下,发现<code>UpdateToProject()</code>接口内<code>PATH_GET_IMAGE_WINDOWS</code>路径不对。改为保存附件的文件夹名即可。</p>
</li>
<li><p>然后就是双击点开预览的坑了。发现一直在加载但就是不出来,控制台反应调接口报错。请了老员工帮我看，看了快一小时都不知道为什么,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来同事说预览的话需要本地有个插件,然后给了我<strong>LibreOffice 5</strong>文件夹,但是也没说放在哪,我就放到项目里面结果依然没用。实在没办法了,只好再请陈老师出山,当然,我也问了他是否需要<strong>LibreOffice 5</strong>以及放的位置对不对。然后继续打开配置文件,发现<br><img src="../../../../images/ext_yulanchajian.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这就真的很尴尬了,原来需要两个插件而且路径也得放对。。。23333333333。然后,解决。。。这坑真的很烦,还浪费时间！</p>
</li>
</ul>
<p>(2).<a id="42"><strong>Could not find action or result;No result defined for action</strong>报错。</a><br><a href="#1">返回目录</a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;依然是个很尴尬的问题。由于java类里面某个字段是<strong>double</strong>类型,但是我在测试时投机取巧直接复制粘贴,所有数据弄一样的,结果传到后台报错。。。一头雾水,发现测试组测试时并没有这个错,这就很奇怪了。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后打了断点发现没进去,页面报404,只好请了同事帮我一起看,两人琢磨了一会然后跟着报错信息找到配置文件<strong>gmo.xml</strong>,他看了下说会不会是你返回的类型不对或者传入的类型不对,这么一说我立马在页面上看,智障,有个字段是<strong>double</strong>类型的我传的是<strong>string</strong>类型,不错才怪。</p>
<p>(3).<a id="43"><strong>下拉选择框</strong></a><br><strong><a href="#1">返回目录</a></strong><br><img src="../../../../images/ext_select.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<code>tools.ComboStore(&#39;example&#39;, gpersist.SELECT_MUST_VALUE)</code>,这里的<strong>example</strong>对应<strong>T_Set_Select</strong>表里的<strong>sqlid</strong>,其中<strong>sqltext</strong>对应<strong>select</strong>语句,且里面至少两个字段,例如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select id,name from 表</div></pre></td></tr></table></figure></p>
<p><strong>但是,在页面上<code>select</code>框展示的永远只有最后一个字段,且向后台传值的话传第一个字段</strong>。</p>
<p>(4).<a id="44"><strong>保存时主键提示语修改</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试组发现新增时,有的编号是主键并且是<strong>String</strong>类型的,没法自增,只能新增时填写。但是,他们故意新增了个已经存在的编号结果报主键冲突,这样肯定是不好的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我一开始的想法是在后台保存前先调用<strong>search</strong>方法查看表里已有的数据,然后通过循环遍历来判断目前新增的编号是不是已经存在,如果存在就不保存给提示。但是由于我java并不擅长,写得时候接收<strong>search</strong>方法返回的参数时就出现了问题,遂问黄健雄。然后他立马制止了我这么干,因为直接在<strong>action</strong>层调方法有风险,尤其是<strong>search</strong>方法打印输出流会对<strong>save</strong>方法造成影响,然后他提供了个思路即找到报错类型加个判断改变提示语,这个方法真的很巧妙！<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来我追踪打印了报主键冲突作物的状态码,然后通过判断改变提示语。<br><img src="../../../../images/ext_zhujianchongtu.png" alt=""></p>
<p>(5).<a id="45"><strong>新增时发现数据默认-2以及me.disNews</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第一次写页面时纯复制粘贴,当时留了个坑,如图：<br><img src="../../../../images/ext_disNews.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;点击新增时居然出现<strong>-2</strong>,虽然能正常编辑保存,但是这样肯定是不美观的。直到最近写过三次并且有时间折腾了才发现,原来是<code>OnInitData()</code>方法里面的问题。初始化赋值时可能后台并没有返回值所以给了个默认值-2。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;还有另一个问题是<code>me.disNews,me.disEdits,me.enNews,me.enEdits</code>。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">me.disNews = [&apos;a&apos;];</div><div class="line">me.disEdits = [&apos;a&apos;];</div><div class="line">me.enNews = [&apos;b&apos;];</div><div class="line">me.enEdits = [&apos;b&apos;];</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一开始我如上面代码所写,结果页面是这样的,<br><img src="../../../../images/ext_disNews2.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这样肯定不好,我需要两个都能编辑,所以我全放开,改成这样：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// me.disNews = [&apos;a&apos;];</div><div class="line">// me.disEdits = [&apos;a&apos;];</div><div class="line">me.enNews = [&apos;a&apos;,&apos;b&apos;];</div><div class="line">me.enEdits = [&apos;b&apos;];</div></pre></td></tr></table></figure></p>
<p>结果：<br><img src="../../../../images/ext_disNews3.png" alt=""><br>很明显这样是不对的,应该改成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// me.disNews = [&apos;a&apos;];</div><div class="line">// me.disEdits = [&apos;a&apos;];</div><div class="line">me.enNews = [&apos;a&apos;,&apos;b&apos;];</div><div class="line">me.enEdits = [&apos;a&apos;,&apos;b&apos;];</div></pre></td></tr></table></figure></p>
<p>(6).<a id="46"><strong>双击列表跳转页面查看详情时发现有些字段没有值</strong></a><br><strong><a href="#1">返回目录</a></strong><br><img src="../../../../images/ext_novalue.png" alt=""><br><img src="../../../../images/ext_novalue2.png" alt=""><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;如上图所示,查看详情时发现<strong>试验地点</strong>字段没有值,但是在列表页<strong>search</strong>接口返回了,那为什么会少值呢？<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我查看浏览器打印台,发现并没有调其他接口,这就很奇怪了,值怎么来的？<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;后来我发现,原来是通过<code>OnLoadData()</code>方法进行赋值的。我一开始猜测可能是先通过<strong>search</strong>接口获取到后台传过来的数据然后进行赋值,可是当我把后台传过来的所有数据都给它赋值上去后,页面上仍然没有值,明明接口里有返回的数据,但是为什么查看详情页会没有值呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> OnLoadData:function(item)&#123;</div><div class="line">   var me = this;</div><div class="line">   var mep = me.tranPrefix;</div><div class="line">   // item 里的属性对应 T_Set_Sql_Column 表里设置的属性,如果发现不全就补全或者类似下面注释的方法重新调接口获取</div><div class="line">   // var item = tools.JsonGet(tools.GetUrl(&apos;Get接口?trmproject.projectid=&apos;) + item.projectid);</div><div class="line">   // console.log(item)</div><div class="line">   var curDate = new Date()</div><div class="line">//格式化;</div><div class="line">var time=Ext.Date.format(curDate, &apos;Y-m-d H:i:s&apos;);</div><div class="line">   if (item &amp;&amp; !Ext.isEmpty(item.projectid)) &#123;</div><div class="line">     tools.SetValue(mep+&apos;projectid&apos;,item.projectid);</div><div class="line">     ...</div><div class="line"> &#125;,</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我试着打印<code>item</code>,发现里面的数据很少,列表页展示了多少它就多少,我很奇怪,why?后来问了陈老师,才知道：<strong><code>item</code>里的属性对应 T_Set_Sql_Column 表里设置的属性,如果发现不全就补全或者类似上面注释的方法重新调接口获取</strong>,该<code>item</code>的属性其实对应着列表页的各个列名(当然,只要表里有对应的字段即使隐藏了也有对应的值。)</p>
<p>(7).<a id="47"><strong>从父类复制过来的按钮没有显示</strong></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可能<strong>id</strong>冲突了,<strong>id</strong>名字改下。</p>
<p>(8).<a id="48"><strong>权限问题</strong></a><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在开发过程中,会发现<code>action</code>层方法开头都有<code>Menus = &quot;101&quot;</code>之类的,一开始没怎么关注过,同事们一般也没管直接复制粘贴没改过。但是我作死改过,发现页面无数据,点开浏览器NetWork,返回值是<strong>[]</strong>,打断点也没没进去,当然折腾了好久。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;然后找了黄健雄帮忙,黄健雄也不知道什么原因,但是看到返回值是<strong>[]</strong>,说记得拦截器那边会返回<strong>[]</strong>。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>既然如此,便试着在拦截器打了个断点,进去了,发现果然有个循环遍历<code>menus</code>(即该用户的权限值数组)。恰好我写的那个方法开头的<code>Menus值</code>不在该数组内,所以调用不了我写的那个方法。</strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个坑真的熊都没遇到过,因为都是复制粘贴所以从没遇到这个坑,也算长见识了。</p>
<p>(9).<a id="49"><strong>数据中存在空格、换行等页面展示/n字符问题</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试在输入时使用了换行符,结果存到数据库里面去了,取得时候就发现后面带个<code>/n</code>,页面上展示出来很丑。后来发现前台<strong>tools.js</strong>里面有针对该情况的解决方法即<code>tools.ReplaceValue</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">tools.ReplaceValue = function (str) &#123;</div><div class="line">  var result = &quot;&quot;;</div><div class="line">  if (str)&#123;</div><div class="line">    var en = new RegExp(&apos;///n&apos;,&apos;g&apos;); </div><div class="line">    var er = new RegExp(&apos;///r&apos;,&apos;g&apos;);</div><div class="line">    var et = new RegExp(&apos;///t&apos;,&apos;g&apos;);</div><div class="line">    var el = new RegExp(&apos;“&apos;,&apos;g&apos;);</div><div class="line">    var eg = new RegExp(&apos;”&apos;,&apos;g&apos;);</div><div class="line">    result = str.replace(en,&apos;\n&apos;).replace(er,&apos;\r&apos;).replace(et,&apos;\t&apos;).replace(el,&apos;&quot;&apos;).replace(eg,&apos;&quot;&apos;)</div><div class="line">    return result;</div><div class="line">  &#125;</div><div class="line">  else</div><div class="line">    return result;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;补充说明：在后期测试时发现列表面板里依然出现<code>///n</code>这种符号,但详情页没有。这时候一个解决思路是找到列表对应的<code>search</code>接口手动把数据<code>replaceAll</code>掉。</p>
<p>(10).<a id="50"><strong>进入详情页控制台报<code>cannot read property &#39;getLeft&#39; of undefined</code>问题</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;点击进入详情页,带附件面板的。发现控制台报错,如下图。<br><img src="../../../../images/ext_bug_getLeft.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;点开发现是<strong>ext-all-debug.js</strong>里面的方法报错,然后我找阿找,愣是没找到<code>this.el</code>是什么。实在没办法我在页面上试。一开始发现如果没有附件没有报错,所以在想是不是附件加载的问题,但是后来发现即使没有附件也会报错,只是不立即报错,当时想难道是定时器？但是页面上也没有啊。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">isOnLeftEdge: function(e) &#123;</div><div class="line">  return (e.getXY()[0] - this.el.getLeft() &lt;= this.handleWidth);</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;偶然间,真的是偶然间发现,鼠标移动到附件面板时出现了报错,我当时就操了。然后看附件面板代码,也没看出什么不同。后来仔细移动鼠标,发现<strong>移动到附件面板列名时报错！！！</strong>amazing!!!<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这下大概知道了是面板列名的错,我把<code>var urlcolumncaskask</code>注释掉,果然不报错,但是页面上也没有列名了,这样肯定不行的。然后我仔细对比发现,<strong>下方多了一段一模一样的代码</strong>,然后注释掉,艹,没问题了。fuck！！！<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong>这明显是代码复制粘贴时没有复制全或者没有删全造成的,不过如果仅仅复制粘贴的话,的确不知道该代码有什么用。所以还是要理解下的。</strong><br>我多出来的代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//     me.detailFuncs = Ext.create(&apos;Ext.util.MixedCollection&apos;);</div><div class="line">//    me.columnCaseAsk = [];</div><div class="line">//    me.fieldCaseAsk = [];</div><div class="line">//    me.OnGetDetailFunction();</div><div class="line">//    var urlcolumncaskask = &apos;SysSqlColumn.do?sqlid=p_get_trmrulesattach&apos;;</div><div class="line">//    var urlcaseaskstore = &apos;TrmSearchTrmRulesAttach.do&apos;;</div><div class="line">//    tools.GetGridColumnsByUrl(urlcolumncaskask, me.columnCaseAsk, me.fieldCaseAsk, mep + &apos;_sh_&apos;, me.detailFuncs, me.hasDetailCheck);</div><div class="line">//    me.gridSaleHighStore = tools.CreateGridStore(tools.GetUrl(this.urlcaseaskstore), me.fieldCaseAsk);</div><div class="line">//    Ext.each(me.columnCaseAsk, function (col, index) &#123;</div><div class="line">//      if (col.xtype == &apos;checkcolumn&apos;) &#123;</div><div class="line">//        col.on(&apos;beforecheck&apos;, function(check) &#123; </div><div class="line">//          if (me.dataDeal == gpersist.DATA_DEAL_SELECT) </div><div class="line">//            check.isCancel = true;</div><div class="line">//          else </div><div class="line">//            check.isCancel = false;</div><div class="line">//        &#125;);</div><div class="line">//      &#125;;</div><div class="line">//    &#125;);</div><div class="line">//    me.OnBeforeCreateDetail();</div></pre></td></tr></table></figure></p>
<p>(11).<a id="51"><strong>详情页有附件面板,新增时,附件面板默认出现某条数据的问题</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试发现,带有附件面板的详情编辑页,在新增时会默认有一条附件数据,这是不对的。如图：<br><img src="../../../../images/ext_new.png" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很明显,新增时刚进入页面,图上的附件面板附件编号22那条数据不应该出现。我看了下<strong>NetWork</strong>,发现一进页面就掉接口得到返回值了。其实如果是双击查看详情页或者修改的情况下这样是没问题的,但是可惜新增时也调了同样的方法,开发过程中忽略了新增时这个情况,所以需要做个判断。如果是新增的情况下,就不给它调接口。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是,该判断怎么加呢？加在哪呢？<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;我发现该接口分别在<code>OnDetailRefresh()</code>方法以及<code>OnCreateEditWin()</code>里面调用。我先是注释掉<code>OnCreateEditWin()</code>里面的接口,没用;然后注释掉<code>OnDetailRefresh()</code>里面的接口,有用。但是双击查看时附件也不见了,说明需要在<code>OnDetailRefresh()</code>里加个判断。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;但是我们需要知道它点新增时调用的是什么方法,点开父类找到<code>OnNew()</code>方法,发现它里面调用了<code>OnInitData()</code>方法,在<code>OnInitData()</code>里发现又调用了<code>OnDetailRefresh()</code>方法。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;好像很明了了,但是回到子类看完全不是啊,子类把<code>OnInitData()</code>方法重写了,子类里面的<code>OnInitData()</code>完全没有调用<code>OnDetailRefresh()</code>,反而是在<code>OnLoadData()</code>里面调用的。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;一开始我以为可以通过传递<code>id</code>给<code>OnDetailRefresh()</code>方法,然后没有<code>id</code>就不调接口。确实实现了,但是出现了另一个问题即<strong>当我先点击其他带有附件的记录并进入详情页查看后,然后点击新增时发现附件面板依然有数据,恰好是刚刚点击查看详情的那条记录的附件信息,很明显,这依然不对。然后我发现<code>NetWork</code>并没有调接口,那只能说明是先前加入面板的数据没有清空,所以我百度了下找到了清空方法,在调接口前先使用<code>me.plCheckGrid.store.removeAll()</code>清空面板就可以了。</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">// OnLoadData()方法</div><div class="line">me.OnDetailRefresh(id);</div><div class="line">// OnDetailRefresh()方法</div><div class="line">OnDetailRefresh : function(itemId) &#123;</div><div class="line">  var me = this;</div><div class="line">  var mep = me.tranPrefix;</div><div class="line">  var id = tools.GetValue(mep+&apos;id&apos;);</div><div class="line">  var ide = tools.GetEncode(tools.GetEncode(id));</div><div class="line">  me.plCheckGrid.store.removeAll();</div><div class="line">  if (me.plCheckGrid &amp;&amp; me.plCheckGrid.store &amp;&amp; id) &#123;</div><div class="line">    me.plCheckGrid.store.proxy.url = tools.GetUrl(&apos;接口.id=&apos;) + id;</div><div class="line">    me.plCheckGrid.store.load();</div><div class="line">  &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>(12)<a id="52"><strong>下拉框验证问题</strong></a><br><strong><a href="#1">返回目录</a></strong><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;测试给熊提了个bug,说下拉框没有选择默认’请选择’字段点击保存居然也可以,存到数据库中值为<strong>-2</strong>,这时很明显需要加个验证提示。打开<strong>tools.js</strong>里面的<code>tools.FormCombo()</code>方法,发现只有不为空的验证,其他什么验证也没有。后来熊在网上找到了Ext中的combox以及里面自带的属性,其中有一个函数<code>validator()</code>可以用来进行其他验证。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;添加的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">validator: function(value) &#123;</div><div class="line">  if(value == &apos;--请选择--&apos;) &#123;</div><div class="line">    return &apos;请选择&apos; + label + &apos;！&apos;;</div><div class="line">  &#125; else &#123;</div><div class="line">    return true;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>(12)<a id="53"><strong>部分word 2007/2010 不能预览问题</strong></a><br><strong><a href="#1">返回目录</a></strong><br>发现word 2007/2010版本的无法预览,后台报错<code>org.artofsolving.jodconverter.office.OfficeException</code>,百度搜了下可能是插件兼容性的问题,目前无解。。。<br>黄健雄找了个折中的方法,在接口内部加一个<code>ReturnValue</code>,然后通过判断<code>ReturnValue</code>来改写提示语。</p>
<blockquote>
<p>好吧,最终解决了。感谢陈德林陈老师,他之前也发现过 word 2007 以上版本有问题,然后他改了下代码,好吧,我看不懂也改不了。实力太菜。。。</p>
</blockquote>
<p>FileUpload里面的copy方法修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int numBytesRead = 0;</div><div class="line">// 一次写入多个字节到输出流中,减少IO访问次数</div><div class="line">while((numBytesRead = in.read(buffer)) != -1) &#123;</div><div class="line">  out.write(buffer, 0, numBytesRead);</div><div class="line">&#125;</div><div class="line">// 多次写字节到输出流中,在office 2007 版本以上会报错</div><div class="line">//  while (in.read(buffer) &gt; 0) &#123;  </div><div class="line">//    out.write(buffer);  </div><div class="line">//  &#125;</div></pre></td></tr></table></figure></p>

  </section>

</article>

<section class="read-more">
           
    
               
            <div class="read-more-item">
                <span class="read-more-item-dim">Newer Post</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/02/09/js函数作用域和块作用域/" title="js函数作用域和块作用域">js函数作用域和块作用域</a></h2>
                <p class="excerpt">
                
                学习自《你不知道的javascript》一、函数作用域1.1 规避冲突12345678910function foo() &amp;#123;    function bar(a) &amp;#123;        i = 3;                      // 修改for循环中的i        
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-02-09T09:04:23.209Z" class="post-list__meta--date date">2018-02-09</time> &#8226; <span class="post-list__meta--tags tags">于 </span><a class="btn-border-small" href="/2018/02/09/js函数作用域和块作用域/">继续阅读</a></div>
                           
            </div>
        
        
               
            <div class="read-more-item">
                <span class="read-more-item-dim">Older Post</span>
                <h2 class="post-list__post-title post-title"><a href="/2018/01/22/js词法作用域/" title="js词法作用域----静态作用域">js词法作用域----静态作用域</a></h2>
                <p class="excerpt">
                
                学习自《你不知道的javascript》和：https://github.com/mqyqingfeng/Blog/issues/3js采用词法作用域(lexical scoping),也就是静态作用域！！！
词法作用域是由你在写代码时将变量和块作用域写在哪里来决定的。即编写代码的时候作用域就定义好
                &hellip;
                </p>
                <div class="post-list__meta"><time datetime="2018-01-22T03:40:00.340Z" class="post-list__meta--date date">2018-01-22</time> &#8226; <span class="post-list__meta--tags tags">于 </span><a class="btn-border-small" href="/2018/01/22/js词法作用域/">继续阅读</a></div>
                       
            </div>
        
     
   
   
  
</section>

  

            <footer class="footer">
    <span class="footer__copyright">
        &copy; 2018 lizhongzhen - 本站点采用 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>
       
    </span>
    <span class="footer__copyright">
             - 基于 <a href="http://hexo.io">Hexo</a> 搭建，使用 <a href="https://github.com/monniya/hexo-theme-new-vno ">new-vno</a> 主题，由<a href="https://monniya.com ">@Monniya</a> 修改自 <a href="https://github.com/lenbo-ma/hexo-theme-vno" target="_blank">Vno</a>, 原创出自<a href="http://github.com/onevcat/vno" target="_blank">onevcat</a>
         </span>
       
    
    
</footer>


        </div>
    </div>

     
<script>
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	ga('create', 'UA-78918255-1', 'auto');
	ga('send', 'pageview');
</script>

    
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?9cdad07c755fa23f6aced510c6760e87";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>



    <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    
</body>
</html>
